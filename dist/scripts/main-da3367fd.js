"use strict";var NB=NB||{};console.time("initialize app"),NB.DUR_FAST=200,NB.DUR_SLOW=2e3,NB.RESIZER_WIDTH=24,NB.splitPos=0,NB.IS_LOCALHOST=document.location.host.match(/localhost/)?!0:!1,NB.hasTouch=!1,NB.oldestStory=1/0;var targetLocalStorageVersion=1,lsVersion=localStorage.v?localStorage.v:0;targetLocalStorageVersion>lsVersion&&(console.log("Clearing local storage."),localStorage.clear(),localStorage.v=targetLocalStorageVersion);var NB=NB||{};NB.Utils=function(){var t={};return t.constrain=function(t,e,o){return e=Math.max(t,e),e=Math.min(e,o)},t.unescape=function(t){var e={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#x27;":"'","&#x60;":"`","&#x2F;":"/"},o=function(t){return e[t]},n=Object.keys(e).join("|"),r="(?:"+n+")",a=RegExp(r),i=RegExp(r,"g");return t=null==t?"":""+t,a.test(t)?t.replace(i,o):t},t}();var NB=NB||{};NB.Settings=function(){function t(){if(localStorage.settings){var t=JSON.parse(localStorage.settings);t.clickAction&&u.clickAction(t.clickAction),t.rightClickAction&&u.rightClickAction(t.rightClickAction),t.source&&("rd"===t.source&&(t.source="rdt"),"hn"===t.source&&(t.source="hxn"),u.source(t.source)),t.hitLimit&&u.hitLimit(+t.hitLimit),t.rdtMinScore&&u.rdtMinScore(+t.rdtMinScore),t.hxnMinScore&&u.hxnMinScore(+t.hxnMinScore)}}function e(){var e="rdt";"#hxn"===window.location.hash&&(e="hxn",window.history&&window.history.replaceState?window.history.replaceState("",document.title,window.location.pathname):window.location.hash=""),d3.select("#open-settings-btn").on("click",u.openSettings),d3.select("#save-settings-btn").on("click",u.saveSettings),d3.select("#cancel-settings-btn").on("click",u.cancelSettings),u.clickAction=ko.observable("storyPanel"),u.rightClickAction=ko.observable("toggleRead"),u.source=ko.observable(e),u.hitLimit=ko.observable(100),u.rdtMinScore=ko.observable(500),u.hxnMinScore=ko.observable(5),u.favMinScore=ko.observable(0),u.hxnCategoryColors=ko.observableArray([{category:"Ask HN",color:"#e74c3c"},{category:"Show HN",color:"#16a085"},{category:"Everything else",color:"#2980b9"}]),u.rdtCategoryColors=ko.observableArray([{category:"AskReddit",color:"#2980b9"},{category:"funny",color:"#2ecc71"},{category:"pics",color:"#e67e22"},{category:"aww",color:"#8e44ad"},{category:"videos",color:"#e74c3c"},{category:"Showerthoughts",color:"#f1c40f"},{category:"Everything else",color:"#7f8c8d"}]),d=d3.select("#settings-modal"),t()}function o(){d.transition().duration(500).style("opacity",0).transition().style("display","none")}function n(t){t||NB.Data.emit("updateSettings",{settings:ko.toJS(u)});var e=NB.Utils.constrain(1,u.hitLimit(),500);u.hitLimit(e),e=Math.max(0,u.rdtMinScore()),u.rdtMinScore(e),e=Math.max(0,u.hxnMinScore()),u.hxnMinScore(e);var n={clickAction:u.clickAction(),rightClickAction:u.rightClickAction(),source:u.source(),hitLimit:u.hitLimit(),rdtMinScore:u.rdtMinScore(),hxnMinScore:u.hxnMinScore()},r={};localStorage.settings&&(r=JSON.parse(localStorage.settings)),u.hitLimit()!==r.hitLimit&&(NB.Chart.reset(),NB.Data.getData());var a=u.source(),i=u[a+"MinScore"];i&&i()!==r[a+"MinScore"]&&(NB.Chart.reset(),NB.Data.getData()),localStorage.settings=JSON.stringify(n),o()}function r(t){var e=Object.keys(t);e.forEach(function(e){u.setSetting(e,t[e],!0)})}function a(){d.style("display","block").transition().duration(100).style("opacity",1)}function i(){t(),o()}function s(t){return u[t]?u[t]():void console.log(t+" is not a setting.")}function c(t,e,o){return u[t]?(u[t](e),void n(o)):void console.log(t+" is not something that can be set.")}function l(t,e){if(!u[t+"CategoryColors"])return void console.log("There are no colours for this source");for(var o,n=u[t+"CategoryColors"](),r=0;r<n.length;r++){if(n[r].category===e)return n[r].color;"Everything else"===n[r].category&&(o=n[r].color)}return o}var d,u={};return u.openSettings=a,u.saveSettings=n,u.cancelSettings=i,u.getSetting=s,u.setAll=r,u.setSetting=c,u.getColor=l,e(),u}();var NB=NB||{};NB.Auth=function(){function t(){return window.location.hash&&"#_=_"===window.location.hash?window.history&&window.history.replaceState?window.history.replaceState("",document.title,window.location.pathname):void(window.location.hash=""):void 0}function e(){u.transition().duration(500).style("opacity",0).transition().style("display","none")}function o(){e()}function n(){u.style("display","block").transition().duration(500).style("opacity",1)}function r(){}function a(e){e.reddit?$("body").addClass("user-rdt"):$("body").removeClass("user-rdt"),d=e;var o=e.displayName||e.name.display;e?(g._id=e._id,g.displayName(o),g.signedIn(!0),g.headerText(o),t()):(g._id=null,g.displayName(null),g.signedIn(!1),g.headerText("Sign in"))}function i(){return g.signedIn()?g:null}function s(){return d}function c(){console.log("OK, will sign out (ha ha, but I am not really!")}var l={},d={},u=d3.select("#auth-modal"),g={_id:"",name:{first:ko.observable(""),last:ko.observable(""),display:ko.observable("")},displayName:ko.observable(""),signedIn:ko.observable(!1),headerText:ko.observable("Sign in"),open:n,close:e,save:o};return l.setUser=a,l.getUser=i,l.getRawUser=s,l.signOut=c,l.userModel=g,r(),l}();var NB=NB||{};NB.Data=function(){function t(t,e){e=e||"commentCount",t.sort(function(t,o){return o[e]-t[e]})}function e(t){var e=NB.Settings.getSetting("source"),o=NB.Settings.getSetting(e+"MinScore");t.forEach(function(t){var e=p.stories.filter(function(e){return e._id===t._id})[0];e?(e.commentCount=t.commentCount,e.score=t.score):t.postDate>NB.oldestStory&&t.score>o&&p.stories.push(t)})}function o(e){return e.forEach(function(t){t.postDate=new Date(t.postDate)}),t(e,"commentCount"),e}function n(t){var e,o,n,r,a=localStorage.readList?JSON.parse(localStorage.readList):[],i=localStorage.favs?JSON.parse(localStorage.favs):[],s=t.stories||[],c=t.user?t.user.stories:[];for(e=0;e<s.length;e++){n=s[e];t:for(o=0;o<c.length;o++)if(r=c[o],r.storyId===n._id){r.read&&(n.isRead=!0),r.fav&&(n.isFav=!0),n.vote=r.vote;break t}a.indexOf(n._id)>-1&&(n.isRead=!0),i.indexOf(n._id)>-1&&(n.isFav=!0)}return t.user&&(delete localStorage.readList,delete localStorage.favs),t}function r(e,o,r){o&&(NB.oldestStory=1/0),e=n(e),e.user&&(NB.Auth.setUser(e.user),e.user.settings&&NB.Settings.setAll(e.user.settings)),e.stories.forEach(function(t){t.postDate=new Date(t.postDate),t.isRead||(t.isRead=s(t._id)),o&&(NB.oldestStory=Math.min(NB.oldestStory,t.postDate))}),t(e.stories,"commentCount"),r(e.stories)}function a(t){var e=NB.Settings.getSetting("hitLimit");$.get("/api/hxn/"+e+"/"+t,function(t){"hxn"===NB.Settings.getSetting("source")&&t.stories.length&&r(t,!0,function(t){t&&(p.stories=t,NB.Chart.drawChart())})})}function i(t){console.timeEnd("initialize app"),console.time("get data (AJAX)");var e=NB.Settings.getSetting("hitLimit");$.get("/api/rdt/"+e+"/"+t,function(t){console.timeEnd("get data (AJAX)"),console.time("parse data"),"rdt"===NB.Settings.getSetting("source")&&t.stories.length&&r(t,!0,function(t){t&&(p.stories=t,console.timeEnd("parse data"),console.time("prepare chart"),NB.Chart.drawChart())})})}function s(t){for(var e=t.toString(),o=!1,n=0;n<y.length;n++)e===y[n]&&(o=!0);return o}function c(t){t=t.toString(),p.emit("markAsUnread",{storyId:t});for(var e=0;e<y.length;e++)if(y[e]===t)return y.splice(e,1),void(localStorage.readList=JSON.stringify(y))}function l(t){s(t)||(y.push(t),NB.Auth.getUser()?p.emit("markAsRead",{storyId:t}):localStorage.readList=JSON.stringify(y))}function d(){h=io(),h.on("data",function(t){if(p.stories.length){var n=NB.Settings.getSetting("source");t.data.length&&t.source===n&&(e(o(t.data)),NB.Chart.drawChart())}})}function u(t,e){var o=NB.Auth.getUser();o&&(e.userId=o._id,h.emit(t,e))}function g(t,e){v[t]=e}function m(){var t=NB.Settings.getSetting("source")||"rdt",e=NB.Settings.getSetting(t+"MinScore");if("rdt"===t)i(e);else if("hxn"===t)a(e);else if("fav"===t){var o=NB.Favs.getAll();o.forEach(function(t){t.postDate=new Date(t.postDate)}),p.stories=o,NB.Chart.drawChart()}}function f(t,e){function o(t){if(t.is_album){if(!t.images)return;for(n=0;n<t.images.length;n++)r=t.images[n],a+="<figure>",a+='<img src="'+r.link+'">',a+=r.title?"<figcaption>"+r.title+"</figcaption>":"",a+="</figure>",a+=r.description?"<p>"+r.description+"</p>":""}else a+="<figure>",a+='<img src="'+t.link+'">',a+=t.description?"<figcaption>"+t.description+"</figcaption>":"",a+="</figure>";e(a)}var n,r,a="",i="https://api.imgur.com/3/gallery/"+t;$.get(i,function(t){o(t.data)})}var h,p={},v={},y=[];return localStorage.readList&&(y=JSON.parse(localStorage.readList)),p.stories=[],p.emit=u,p.setData=g,p.markAsRead=l,p.markAsUnread=c,p.getData=m,p.getImgurGalleryAsHtml=f,d(),p}();var NB=NB||{};NB.Favs=function(){function t(){if(localStorage.favs){var t=JSON.parse(localStorage.favs);Array.isArray(t)&&(o=t)}}var e={},o=[];return e.addToFavs=function(t){o.push(t),localStorage.favs=JSON.stringify(o),NB.Data.emit("addToFavs",{story:t})},e.removeFromFavs=function(t){var e=t._id;NB.Data.emit("removeFromFavs",{storyId:t._id}),o.forEach(function(t,n){return t._id===e?(o.splice(n,1),void(localStorage.favs=JSON.stringify(o))):void 0})},e.isFav=function(t){if(!o.length)return!1;var e=t._id,n=!1;return o.forEach(function(t){t._id===e&&(n=!0)}),n},e.toggleFav=function(t){var o=t.raw,n=e.isFav(o);return n?(e.removeFromFavs(o),t.isFav(!1),!1):(e.addToFavs(o),t.isFav(!0),!0)},e.getAll=function(){return o},t(),e}();var NB=NB||{};NB.Layout=function(){function t(){a.style("width",NB.splitPos+"px"),i.style("left",NB.splitPos+"px")}function e(){t(),a.style("display","block"),i.style("display","block")}function o(){s||(s=!0,d3.select("#story-panel-toggle").text("»"),NB.splitPos=.618*document.body.offsetWidth,t(),NB.Chart.resize("fast"))}function n(e){(e||s)&&(s=!1,d3.select("#story-panel-toggle").text("«"),NB.splitPos=document.body.offsetWidth-NB.RESIZER_WIDTH,t(),NB.Chart.resize("fast"))}var r={},a=d3.select("#chart-wrapper"),i=d3.select("#story-panel"),s=!1;return r.render=function(){t(),document.body.offsetWidth-NB.splitPos<100&&n(!0),s||NB.splitPos+NB.RESIZER_WIDTH===document.body.offsetWidth||n(!0)},r.moveSplitPos=function(){s||(s=!0,d3.select("#story-panel-toggle").text("»")),t()},r.showStoryPanel=function(){o()},r.hideStoryPanel=function(){n()},r.toggleStoryPanel=function(){s?n():o()},r.init=function(){e()},r}();var NB=NB||{};NB.Chart=function(){function t(t,e){t.classed("read")?(t.classed("read",!1),NB.Data.markAsUnread(e._id)):(t.classed("read",!0),NB.Data.markAsRead(e._id))}function e(){var t=d3.event.currentTarget;if(t.previousSibling){var e=t.parentNode,o=e.firstChild.nextSibling;e.insertBefore(t,o)}}function o(o){e();var n=d3.select(d3.event.currentTarget);d3.select(".selected").classed("selected",!1),n.classed("selected",!0);var r=NB.Settings.getSetting("clickAction");if("storyPanel"===r&&(NB.Data.markAsRead(o._id),n.classed("read",!0),NB.Layout.showStoryPanel(),NB.StoryPanel.render(o)),"storyTooltip"===r){var a=d3.select("#story-tooltip"),i=parseInt(a.style("width")),s=parseInt(a.style("height")),c=n.node().getBoundingClientRect(),l=B(o.commentCount),d=c.left+l-i/2,u=b-i-20;d=Math.min(d,u),d=Math.max(d,0);var g=c.top-s;50>g&&(g=c.bottom),NB.StoryModel.setCurrentStory(o);var m=d3.select("#tooltip-mark-as-read");m.text(n.classed("read")?"Mark as unread":"Mark as read");var f=NB.App.view.showMaxiTooltip()?200:0;NB.App.view.showMaxiTooltip(!0),a.transition().duration(f).style("left",d+"px").style("top",g+"px"),d3.event.stopPropagation(),$(document).on("click.tooltip",function(){$(document).off("click.tooltip"),window.setTimeout(function(){NB.App.view.showMaxiTooltip(!1)},300)}),m.on("click",function(){t(n,o)}),d3.select("#tooltip-open-reading-pane").on("click",function(){NB.Data.markAsRead(o._id),n.classed("read",!0),NB.Layout.showStoryPanel(),NB.StoryPanel.render(o)})}D.style("visibility","hidden")}function n(t){if(!NB.App.view.showMaxiTooltip()&&!NB.hasTouch){D.html(t.name+"<br>~ "+t.category+" ~");var e=D.node(0).getBoundingClientRect(),o=e.width,n=e.height,r=d3.event.currentTarget.getBoundingClientRect(),a=r.left-(o-r.width)/2;a=Math.max(a,L.left),a=Math.min(a,b-L.right-o);var i=r.top-n-10;100>i&&(i=r.top+r.height+10),D.style("left",a+"px").style("top",i+"px").style("visibility","visible")}}function r(){D.style("visibility","hidden")}function a(o){var n=NB.Settings.getSetting("rightClickAction");if("nothing"!==n){d3.event.preventDefault(),e();var r=d3.select(d3.event.currentTarget);t(r,o)}}function i(t){var e=p.selectAll("circle").data(NB.Data.stories,function(t){return t._id});e.classed("updating",!0),console.timeEnd("prepare chart"),e.enter().append("circle").attr("r",function(t){return B(t.commentCount)}).attr("cx",function(){return N(T)+100}).attr("cy",function(){return S(I)+100}).attr("fill",function(t){return NB.Settings.getColor(t.source,t.category)}).attr("stroke",function(t){return NB.Settings.getColor(t.source,t.category)}).classed("story-circle",!0).classed("read",function(t){return t.isRead}).on("click",o).on("mouseover",n).on("mouseout",r).on("contextmenu",a);var i=0,s=0;"slow"===t&&(i=NB.DUR_SLOW,s=10),"fast"===t&&(i=NB.DUR_FAST,s=0),e.transition().ease("cubic-out").delay(function(t,e){return e*s}).duration(i).attr("r",function(t){return B(t.commentCount)}).attr("cx",function(t){return N(t.postDate)}).attr("cy",function(t){return S(t.score)})}function s(){w=parseInt(d3.select("#chart-wrapper").style("height"),10)-4,b=NB.splitPos,k.ticks(b-L.left-L.right<600?5:10),y=document.body.offsetHeight/20,L.top=40+y/2,h.attr("width",b).attr("height",w),v.attr("transform","translate("+L.left+","+L.top+")").attr("width",b-L.left-L.right).attr("height",w-L.top-L.bottom),N.range([40,b-20]),S.range([w-L.bottom-7,L.top]),B.range([10,y]),A.x(N),M.attr("transform","translate(0,"+(w-L.bottom)+")"),x.innerTickSize(-1*(b-L.left-L.right)),C.attr("transform","translate("+L.left+", 0)"),M.call(k),C.call(x),C.selectAll("text").attr("x",4).attr("dy",-4).style("text-anchor","start")}function c(){var t=T,e=R;R=Math.min(R,d3.min(NB.Data.stories,function(t){return t.postDate})),T=Math.max(T,d3.max(NB.Data.stories,function(t){return t.postDate})),P=Math.max(P,d3.max(NB.Data.stories,function(t){return t.score})),E=Math.min(E,d3.min(NB.Data.stories,function(t){return t.commentCount})),F=Math.max(F,d3.max(NB.Data.stories,function(t){return t.commentCount}));var o=NB.Settings.getSetting("source");I=0,I="fav"===o?d3.min(NB.Data.stories,function(t){return t.score}):NB.Settings.getSetting(o+"MinScore");var n=d3.median(NB.Data.stories,function(t){return t.score}),r=(n-I)/(P-I)*2;r=NB.Utils.constrain(1e-4,r,1),S.domain([I,P]).exponent(r),B.domain([E,F]),(e!==R||t!==T)&&(N.domain([R,T]),A.x(N))}function l(){M.call(k),i()}function d(){A=d3.behavior.zoom().x(N).on("zoom",l)}function u(){d3.selectAll("#svg-bubble-chart > *").remove(),h=d3.select("#svg-bubble-chart"),D=d3.select("#tooltip"),R=1/0,T=0,P=0,E=1/0,F=0,N=d3.time.scale(),S=d3.scale.pow().exponent(.2),B=d3.scale.pow().exponent(.3),k=d3.svg.axis().scale(N).ticks(8).tickSize(3,0),x=d3.svg.axis().scale(S).orient("left").ticks(15).tickSize(0,0);var t=h.append("g").classed("chart-axis",!0);M=t.append("g").classed("chart-axis-x",!0),C=t.append("g").classed("chart-axis-y",!0),d(),p=h.append("g").classed("chart-plot-area",!0).style("pointer-events","all").call(A),v=p.append("rect").attr("class","overlay"),v.on("touchstart.zoom",null)}function g(){c(),s(),i("slow")}function m(){u()}function f(t){NB.Data.stories.length&&(s(),c(),i(t))}var h,p,v,y,N,S,B,b,w,k,x,M,C,D,A,_={},L={top:70,right:0,bottom:30,left:0},R=1/0,T=0,P=0,I=0,E=1/0,F=0;return _.drawChart=g,_.reset=m,_.resize=f,u(),_}();var NB=NB||{};NB.Actions=function(){function t(){}function e(t){var e=NB.Settings.getSetting("clickAction"),o=t.story,r=t.domEl,a=t.chartWidth;if("storyPanel"===e&&(NB.Data.markAsRead(o._id),r.classed("read",!0),NB.Layout.showStoryPanel(),NB.StoryPanel.render(o)),"storyTooltip"===e){var i=d3.select("#story-tooltip"),s=parseInt(i.style("width")),c=parseInt(i.style("height")),l=r.node().getBoundingClientRect(),d=l.left+l.width/2-s/2,u=a-s-20;d=Math.min(d,u),d=Math.max(d,0);var g=l.top-c;50>g&&(g=l.bottom),NB.StoryModel.setCurrentStory(o);var m=d3.select("#tooltip-mark-as-read");m.text(r.classed("read")?"Mark as unread":"Mark as read");var f=n?200:0;i.style("display","block").transition().duration(f).style("left",d+"px").style("top",g+"px"),n=!0,d3.event.stopPropagation(),$(document).on("click.tooltip",function(){i.style("display","none"),$(document).off("click.tooltip"),window.setTimeout(function(){n=!1},300)}),m.on("click",function(){toggleRead(r,o)}),d3.select("#tooltip-open-reading-pane").on("click",function(){NB.Data.markAsRead(o.id),r.classed("read",!0),NB.Layout.showStoryPanel(),NB.StoryPanel.render(o)})}}var o={},n=!1;return o.showTooltip=e,t(),o}();var NB=NB||{};NB.Events=function(){function t(){return"story-panel-toggle"===d3.event.target.id?!1:(a=d3.select("#chart-wrapper").style("transition","0ms"),r=d3.select("#story-panel").style("transition","0ms"),i=d3.select("#story-panel-resizer").classed("active",!0),c=d3.select("body"),s=d3.mouse(document.body)[0]-NB.splitPos,c.on("mousemove",e),c.on("mouseup",o),c.on("touchmove",e),void c.on("touchend",o))}function e(){d3.event.preventDefault(),NB.splitPos=Math.max(100,d3.mouse(document.body)[0]-s),NB.Layout.moveSplitPos(),NB.Chart.resize()}function o(){a.style("transition",null),r.style("transition",null),i.classed("active",!1),document.body.offsetWidth-NB.splitPos<100&&NB.Layout.hideStoryPanel(),c.on("mousemove",null),c.on("mouseup",null),c.on("touchmove",null),c.on("touchend",null)}function n(){window.onresize=function(){NB.Layout.render(),NB.Chart.resize()},d3.select("#story-panel-resizer").on("mousedown",t),d3.select("#story-panel-resizer").on("touchstart",t),d3.select("#story-panel-toggle").on("click",function(){return d3.event.preventDefault(),NB.Layout.toggleStoryPanel(),!1}),$("#more-btn").on("click",function(){NB.Data.getNextPage(function(t){NB.Chart.addStories(t)})})}var r,a,i,s,c,l={};return n(),l}();var NB=NB||{};NB.Comments=function(){function t(t){var e=$("<textarea>").html(t).text();return e=e.replace(/href="(\/r\/.*?)"/g,'href="http://www.reddit.com$1"'),e=e.replace(/href="(\/u\/.*?)"/g,'href="http://www.reddit.com$1"'),e=e.replace(/(<a [^>]*?)(>)/g,'$1 target="_blank"$2'),e=e.replace(/(<a [^>]*?href=)("[^>]*?(?:jpg|png|gif)")(.*?)(<\/a>)/g,"$1$2$3<img src=$2>$4"),e=e.replace(/(<a [^>]*?href=")(http:\/\/imgur\.com\/[^./]*?)(".*?)(<\/a>)/g,'$1$2$3<img src="$2.jpg">$4'),e=e.replace(/<a[^>]*?www\.youtube\.com\/watch\?v=([^?&"]*).*<\/a>/g,'<iframe width="560" height="315" src="//www.youtube.com/embed/$1" frameborder="0" allowfullscreen></iframe>'),e=e.replace(/<a[^>]*?http:\/\/youtu\.be\/([^?&"]*).*<\/a>/g,'<iframe width="560" height="315" src="//www.youtube.com/embed/$1" frameborder="0" allowfullscreen></iframe>')}function e(e,o,n){function r(o){d++;var n=$('<ul class="comment-list level-'+d+'">');return o.forEach(function(o){var l=$('<li class="comment-list-item">');if("more"===o.kind);else if("[deleted]"===o.data.body);else{i=o.data.author,s=moment(1e3*o.data.created_utc).fromNow(),a="http://www.reddit.com/"+e.permalink+o.data.id,c=o.data.score_hidden?"[score hidden]":o.data.score+" points";var d=t(o.data.body_html),u=$('<div class="comment-list-item-text body"></div>');u.append(d),l.append(u),l.append('<p class="comment-list-item-text meta"> '+i+" | "+s+" | "+c+' | <a href="'+a+'" class="reply" target="_blank">reply</a></p>'),o.data.replies&&o.data.replies.data&&o.data.replies.data.children.length&&l.append(r(o.data.replies.data.children))}n.append(l)}),d--,n}var a,i,s,c,l=$("<div>"),d=0,e=o[0].data.children[0].data,u=t(e.selftext_html);u&&(l.append(u),l.append('<h3 class="comment-separator">Comments</h3>')),l.append(r(o[1].data.children)),n(l)}function o(t,o){var n=t.rdt.shortId,r="http://www.reddit.com/comments/"+n+".json";$.get(r,function(n){e(t,n,o)})}function n(t,e){function o(){0===i&&(l=c[0].outerHTML,e(l))}function n(t){s++;var e=$('<ul class="comment-list level-'+s+'">'),a=r+t+".json";return $.get(a).success(function(t){if(t.deleted||t.dead||"comment"!==t.type)return i--,o();var r=$('<li class="comment-list-item">'),a=t.by,c=NB.Utils.unescape(t.text),l=moment(1e3*t.time).fromNow(),d="https://news.ycombinator.com/reply?id="+t.id;r.append('<div class="comment-list-item-text body">'+c+"</div>"),r.append('<p class="comment-list-item-text meta">'+a+" | "+l+' | <a href="'+d+'" class="reply" target="_blank">reply</a></p>'),t.kids&&t.kids.length>-1&&t.kids.forEach(function(t){i++,r.append(n(t))}),e.append(r),i--,s--,o()}),e}var r="https://hacker-news.firebaseio.com/v0/item/",a=r+t.sourceId+".json",i=0,s=0,c=$("<div>");t.hxn.storyText&&(c.append(t.hxn.storyText),c.append('<h3 class="comment-separator test">Comments</h3>'));var l=['<p class="comment-list-title">Head on over to ','<a href="'+t.sourceUrl+'" target="_blank">Hacker News</a> to comment.',"</p>"].join("");c.append(l),$.get(a).success(function(t){return t.kids?(t.kids.forEach(function(t){i++,c.append(n(t))}),void o()):o()})}function r(t,e){n(t,e)}var a={};return a.getForRdtStory=o,a.getForHxnStory=r,a}();var NB=NB||{};NB.StoryPanel=function(){function t(t){var e=t.replace(/.gifv$/,".webm"),o=t.replace(/.gifv$/,".mp4"),n=['<a href="'+t+'" target="_blank">','<video autoplay="" loop="" muted="">','<source type="video/webm" src="'+e+'">','<source type="video/mp4" src="'+o+'">',"</video>","</a>"].join("");return n}function e(t,e){var o="/readability/",n=t.url,r=o+encodeURIComponent(n);$.get(r,function(o){if(o.error){var n=["<h2>Whoa!</h2>","<p>This is far too good for this little panel. Better go see the whole thing ",'<a href="'+t.url+'" target="_blank">here</a>.',"</p>"].join("");e(n)}else e(o.content)})}function o(o){function n(){NB.Comments.getForRdtStory(o,function(t){o.content+='<h3 class="comment-separator">Comments</h3>',o.content+=['<p class="comment-list-title">Head on over to ','<a href="'+o.sourceUrl+'" target="_blank">Reddit</a> to comment.',"</p>"].join(""),o.content+=t.html(),o.sourceId===i?NB.StoryModel.setCurrentStory(o):console.log("The story has already changed, dumping these comments")})}function r(t){NB.StoryModel.setCurrentStory(o),t&&n()}var a=o.rdt.domain.toLowerCase();if(i=o.sourceId,o.content="",o.rdt.self)NB.Comments.getForRdtStory(o,function(t){o.content=t.html(),r()});else if(o.url.match(/(gif|png|jpg)$/))o.content='<img src="'+o.url+'">',r(!0);else if(o.url.match(/gifv$/))o.content=t(o.url),r(!0);else if("i.imgur.com"===a||"imgur.com"===a||"m.imgur.com"===a)if(o.url.match(/\imgur\.com\/a\//)){var s=o.url.replace(/.*?\imgur\.com\/a\//,"");s=s.replace(/#.*/,""),s=s.replace(/\?.*/,"");var c="https://api.imgur.com/3/album/"+s+"/images",l="";$.get(c,function(t){l+='<div class="story-content">',t.data.forEach(function(t){l+='<img src="'+t.link+'"><br>'}),l+="</div>",o.content=l,r(!0)})}else if(o.url.match(/\imgur\.com\/gallery\//)){var d=o.url.match(/imgur\.com\/gallery\/([^?]*)/)[1];NB.Data.getImgurGalleryAsHtml(d,function(t){o.content='<div class="story-content">'+t+"</div>",r(!0)})}else{var u=o.url.replace("imgur.com","i.imgur.com")+".jpg";o.content=['<div class="story-content">','<a href="'+o.url+'" target="_blank"><img src="'+u+'"></a>',"</div>"].join(""),r(!0)}else e(o,function(t){o.content=t,r(!0)})}function n(t){function o(){NB.Comments.getForHxnStory(t,function(e){t.content+='<h3 class="comment-separator">Comments</h3>',t.content+=e,NB.StoryModel.setCurrentStory(t)})}function n(e){NB.StoryModel.setCurrentStory(t),e&&o()}t.url?t.url.match(/pdf\?*.*$/)?(t.content='<a href="'+t.url+'" target="_blank">Open this PDF</a>',n(!0)):e(t,function(e){t.content=e,n(!0)}):NB.Comments.getForHxnStory(t,function(e){t.content=e,n(!1)})}function r(t){s=t,NB.StoryModel.setCurrentStory(t),"rdt"===t.source&&o(t),"hxn"===t.source&&n(t)}function a(){NB.StoryModel.clear()}var i,s,c={};return c.render=r,c.clear=a,c}();var NB=NB||{};NB.StoryModel=function(){function t(t){var e={upOrDown:t,id:r.storyModel.raw._id,sourceId:r.storyModel.raw.sourceId};r.storyModel.userVote(t),$.post("/api/reddit/vote",e,function(t){t.err&&console.log("Error saving a vote:",t)})}function e(){r.storyModel={raw:{},name:ko.observable(),shortName:ko.observable(),url:ko.observable(),sourceUrl:ko.observable(),authorUrl:ko.observable(),category:ko.observable(),color:ko.observable(),author:ko.observable(),commentCount:ko.observable(),score:ko.observable(),timeString:ko.observable(),dateString:ko.observable(),content:ko.observable(""),isFav:ko.observable(!1),userVote:ko.observable(""),upVote:function(){t("up"!==r.storyModel.userVote()?"up":"")},downVote:function(){t("down"!==r.storyModel.userVote()?"down":"")}}}function o(t){var e=d3.time.format("%a, %-e %b %Y"),o=d3.time.format("%-I:%M%p"),n=t.name,a=NB.Favs.isFav(t),i=NB.Settings.getColor(t.source,t.category);name.length>50&&(n=name.substr(0,47).trim()+"..."),r.storyModel.raw=t,r.storyModel.name(t.name).shortName(n).url(t.url).sourceUrl(t.sourceUrl).authorUrl(t.authorUrl).category(t.category).color(i).author(t.author).commentCount(t.commentCount).score(Math.round(t.score)).timeString(o(t.postDate)).dateString(e(t.postDate)).content(t.content).isFav(a).userVote(t.vote)}function n(){r.storyModel.name("").url("").sourceUrl("").authorUrl("").category("").color("").author("").commentCount("").score("").timeString("").dateString("").content("").isFav("").userVote("")}var r={};return r.setCurrentStory=o,r.clear=n,e(),r}();var NB=NB||{};NB.Nav=function(){function t(){e=NB.Settings.getSetting("source"),o.navModel.currentSource(e)}var e,o={};return o.navModel={currentSource:ko.observable(e)},o.navigate=function(t){NB.Layout.hideStoryPanel(),NB.StoryModel.clear(),o.navModel.currentSource(t),NB.Settings.setSetting("source",t),NB.Chart.reset(),NB.Data.getData();var e=d3.select("body");e.classed("rdt","rdt"===t),e.classed("hxn","hxn"===t),e.classed("fav","fav"===t)},t(),o}();var NB=NB||{};NB.App=function(){function t(){ko.applyBindings(e,document.body)}var e={};return e.maxiTooltipVis=ko.observable(!1),e.user=NB.Auth.userModel,e.settings=NB.Settings,e.nav=NB.Nav.navModel,e.storyModel=NB.StoryModel.storyModel,e.view={showMaxiTooltip:ko.observable(!1)},t(),e}();var NB=NB||{};NB.main=function(){NB.splitPos=document.body.offsetWidth-NB.RESIZER_WIDTH,NB.Layout.render(),NB.Layout.init();var t=NB.Settings.getSetting("source")||"rdt",e=NB.Settings.getSetting(t+"MinScore");d3.select("body").classed(t,!0),NB.Data.getData(t,e);var o=function(){document.body.classList.remove("no-touch"),NB.hasTouch=!0,document.body.removeEventListener("touchstart",o)};document.body.addEventListener("touchstart",o)}();