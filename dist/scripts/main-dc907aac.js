"use strict";var HB=HB||{};HB.DUR=200,HB.RESIZER_WIDTH=24,HB.splitPos=0,HB.MIN_POINTS=1,HB.HITS_PER_PAGE=200,HB.POLL_PERIOD=3e5;var HB=HB||{};HB.Data=function(){function t(t){localStorage.stories=JSON.stringify(t),d=t}function e(t,e){e=e||"commentCount",t.sort(function(t,o){return o[e]-t[e]})}function o(t){return t.forEach(function(t){var e=new Date(t.created_at);t.dateTime=e;var o=t.num_comments;t.commentCount=o,t.score=t.points,t.id=t.objectID}),e(t,"commentCount"),t}function n(t){return t.forEach(function(t){var e=new Date(t.data.created);t.dateTime=e;var o=t.data.num_comments;t.commentCount=o,t.score=t.data.score,t.id=t.data.name,t.title=t.data.title,t.url=t.data.url,t.author=t.data.author,t.thumb=t.data.thumbnail}),e(t,"commentCount"),console.log("parsed reddit data:",t),t}function r(e){if("localhost"===document.location.hostname&&localStorage.stories){var n=JSON.parse(localStorage.stories);return n=o(n),console.log("Getting from LS:",n),void e(n)}var r="search_by_date?";r+="tags=(story,show_hn,ask_hn)",r+="&hitsPerPage="+HB.HITS_PER_PAGE,r+="&numericFilters=points>="+HB.MIN_POINTS,$.get("https://hn.algolia.com/api/v1/"+r,function(n){console.log("Updated data at",Date()),n=n.hits,n=o(n),t(n),e(n)})}function a(t){var e="http://www.reddit.com/hot.json?limit=100";$.get(e,function(e){console.log("got data from reddit:",e),e=e.data.children,e=n(e),t(e)})}var i,s={},l={},c=[],d=[];return localStorage.readList&&(c=JSON.parse(localStorage.readList)),s.setData=function(t,e){l[t]=e},s.markAsRead=function(t){c.push(t),localStorage.readList=JSON.stringify(c)},s.isRead=function(t){for(var e=t.toString(),o=0;o<c.length;o++)if(e===c[o])return!0;return!1},s.getRedditData=function(t){a(t,!1)},s.getHNStories=function(t){r(t,!1),r(t,!0)},s.stopPolling=function(){window.clearInterval(i)},s}();var HB=HB||{};HB.Layout=function(){function t(){a.style("width",HB.splitPos+"px"),i.style("left",HB.splitPos+"px")}function e(){t(),a.style("display","block"),i.style("display","block")}function o(){s||(s=!0,d3.select("#story-panel-toggle").text("»"),HB.splitPos=.618*document.body.offsetWidth,t(),HB.Chart.resize(!0))}function n(e){(e||s)&&(s=!1,d3.select("#story-panel-toggle").text("«"),HB.splitPos=document.body.offsetWidth-HB.RESIZER_WIDTH,t(),HB.Chart.resize(!0))}var r={},a=d3.select("#chart-wrapper"),i=d3.select("#story-panel"),s=!1;return r.render=function(){t(),document.body.offsetWidth-HB.splitPos<100&&n(!0),s||HB.splitPos+HB.RESIZER_WIDTH===document.body.offsetWidth||n(!0)},r.moveSplitPos=function(){s||(s=!0,d3.select("#story-panel-toggle").text("»")),t()},r.showStoryPanel=function(){o()},r.hideStoryPanel=function(){n()},r.toggleStoryPanel=function(){s?n():o()},r.init=function(){e()},r}();var HB=HB||{};HB.Chart=function(){function t(t){var e=d3.select(d3.event.currentTarget);d3.select(".selected").classed("read",!0).classed("selected",!1),e.classed("selected",!0),HB.Data.markAsRead(t.id),HB.Layout.showStoryPanel(),$("#story-content").html(""),I.style("visibility","hidden");var o="";if(t.url){if(o+='<h1><a class="title" href="'+t.url+'" target="_blank">'+t.title+"</a></h1>",t.data&&t.data.is_self){$("#story-title").html(o);var n=[t.data.selftext+"<hr>","<p>Built-in reddit comments coming soon. For now, head over to ",'<a href="'+t.url+'" target="_blank">reddit to read more</a>.',"</p>"].join("");return void $("#story-content").html(n)}if(t.url.match(/\.(gif|png|jpg)\?*.*$/))return $("#story-title").html(o),void $("#story-content").html('<a href="'+t.url+'" target="_blank"><img src="'+t.url+'"></a>');if(t.data&&"imgur.com"===t.data.domain){var r=t.url.replace("imgur.com","i.imgur.com")+".jpg";$("#story-title").html(o);var n=["<p>Embedded imgur magic coming soon.",'<a href="'+t.url+'" target="_blank"><img src="'+r+'"></a>',"<br>",'<a href="'+t.url+'" target="_blank">Go to imgur.</a>.',"</p>"].join("");return void $("#story-content").html(n)}}else o+="<h1>"+t.title+"</h1>";if(o+='<p class="sub-title">'+Math.round(t.score)+" points | ","hn"===HB.source&&(o+='<a href="https://news.ycombinator.com/item?id='+t.id+'" target="_blank">'+t.commentCount+" comments</a> | "),o+="posted by "+t.author+"</p>",t.url){var a="/readability/",i=t.url,s=a+encodeURIComponent(i);$.get(s,function(e){if(e.error){var o=["<h2>Oh no.</h2>","<p>This article could not be fetched. You can visit the full page ",'<a href="'+t.url+'" target="_blank">here</a>.',"</p>"].join("");$("#story-content").html(o)}$("#story-content").html(e.content)})}else $("#story-content").html(t.story_text);$("#story-title").html(o)}function e(t){I.text(t.title);var e=parseInt(I.style("width")),o=parseInt(I.style("height")),n=this.getBoundingClientRect(),r=n.left-(e-n.width)/2;r=Math.max(r,N.left),r=Math.min(r,v-N.right-e);var a=n.top-o;100>a&&(a=n.top+n.height),I.style("left",r+"px").style("top",a+"px").style("visibility","visible")}function o(){I.style("visibility","hidden")}function n(n){var r=d.selectAll("circle").data(C,function(t){return t.id});r.enter().append("circle").attr("r",function(t){return H(t.commentCount)}).attr("cx",function(){return g(x)}).attr("cy",function(){return y(0)}).classed("story-circle",!0).classed("read",function(t){return HB.Data.isRead(t.id)}).on("click",t).on("mouseover",e).on("mouseout",o);var a=0;n&&(a=HB.DUR),r.transition().duration(a+500).attr("r",function(t){return H(t.commentCount)}).attr("cx",function(t){return g(t.dateTime)}).attr("cy",function(t){return y(t.score)})}function r(){B=parseInt(d3.select("#chart-wrapper").style("height"),10)-4,v=HB.splitPos,S.ticks(v-N.left-N.right<600?5:10),p=document.body.offsetHeight/20,c.attr("width",v).attr("height",B),m.attr("transform","translate("+N.left+","+N.top+")").attr("width",v-N.left-N.right).attr("height",B-N.top-N.bottom),u.attr("x",N.left).attr("y",0).attr("width",v-N.left).attr("height",B-N.bottom),g.range([40,v-20]),y.range([B-N.bottom-7,N.top]),H.range([7,p]),D.x(g),w.attr("transform","translate(0,"+(B-N.bottom)+")"),P.innerTickSize(-1*(v-N.left-N.right)),_.attr("transform","translate("+N.left+", 0)"),w.call(S),_.call(P),_.selectAll("text").attr("x",4).attr("dy",-4).style("text-anchor","start")}function a(){b=d3.min(C,function(t){return t.dateTime}),x=d3.max(C,function(t){return t.dateTime}),g.domain(d3.extent(C,function(t){return t.dateTime})),y.domain([HB.MIN_POINTS,d3.max(C,function(t){return t.score})]),H.domain(d3.extent(C,function(t){return t.commentCount})),D.x(g)}function i(){w.call(S),n()}function s(){D=d3.behavior.zoom().x(g).scaleExtent([1,100]).on("zoom",i)}function l(){c=d3.select("#svg-bubble-chart"),I=d3.select("#tooltip"),g=d3.time.scale(),y=d3.scale.pow().exponent(.5),H=d3.scale.pow().exponent(.5),S=d3.svg.axis().scale(g).ticks(8).tickSize(3,0),P=d3.svg.axis().scale(y).orient("left").ticks(15).tickSize(0,0),f=c.append("g").classed("stripes",!0);var t=c.append("g").classed("chart-axis",!0);w=t.append("g").classed("chart-axis-x",!0),_=t.append("g").classed("chart-axis-y",!0),k=_.append("text").style("font-size","13px").text("Points").attr("transform","translate(0, 53)"),h=c.append("g").classed("chart-legend",!0).attr("transform","translate(20, 20)");var e=[{title:"Ask HN",className:"story-circle story-circle-ask"},{title:"Show HN",className:"story-circle story-circle-show"},{title:"Story",className:"story-circle"}],o=h.selectAll("g").data(e).enter().append("g").attr("transform",function(t,e){return"translate("+100*e+",0)"}).attr("class",function(t){return t.className});o.append("circle").attr("cx",0).attr("cy",0).attr("r",7),o.append("text").text(function(t){return t.title}).attr("dx",12).attr("dy","0.35em"),s(),d=c.append("g").classed("chart-plot-area",!0).style("pointer-events","all").call(D),m=d.append("rect").attr("class","overlay"),m.on("touchstart.zoom",null),u=d3.select("#plot-area-clip rect")}var c,d,u,m,f,h,p,g,y,H,v,B,b,x,S,P,w,_,k,I,D,R={},C=[],N={top:70,right:0,bottom:30,left:0};return R.drawStories=function(t){C=t,a(),r(),n(!0)},R.addStories=function(t){console.log("Chart.addStories()"),C=C.concat(t),a(),n(!0)},R.resize=function(t){r(),a(),n(t)},l(),R}();var HB=HB||{};HB.Events=function(){function t(t){return"story-panel-toggle"===d3.event.target.id?!1:(console.log("#story-panel-resizer clicked:",t),r=d3.select("#chart-wrapper").style("transition","0ms"),n=d3.select("#story-panel").style("transition","0ms"),a=d3.select("#story-panel-resizer").classed("active",!0),s=d3.select("body"),i=d3.mouse(document.body)[0]-HB.splitPos,s.on("mousemove",e),s.on("mouseup",o),s.on("touchmove",e),void s.on("touchend",o))}function e(){d3.event.preventDefault(),HB.splitPos=Math.max(100,d3.mouse(document.body)[0]-i),HB.Layout.moveSplitPos(),HB.Chart.resize()}function o(){r.style("transition",null),n.style("transition",null),a.classed("active",!1),document.body.offsetWidth-HB.splitPos<100&&HB.Layout.hideStoryPanel(),s.on("mousemove",null),s.on("mouseup",null),s.on("touchmove",null),s.on("touchend",null)}var n,r,a,i,s,l={};return d3.select("#story-panel-resizer").on("mousedown",t),d3.select("#story-panel-resizer").on("touchstart",t),d3.select("#story-panel-toggle").on("click",function(){return console.log("#story-panel-toggle clicked"),d3.event.preventDefault(),HB.Layout.toggleStoryPanel(),!1}),$("#more-btn").on("click",function(){HB.Data.getNextPage(function(t){HB.Chart.addStories(t)})}),window.onresize=function(){HB.Layout.render(),HB.Chart.resize()},l}();var HB=HB||{};HB.main=function(){HB.splitPos=document.body.offsetWidth-HB.RESIZER_WIDTH,HB.Layout.render(),HB.Layout.init(),HB.source="reddit";var t=document.location.search.replace("?src=","");"reddit"===t?HB.source="reddit":"hacker-news"===t&&(HB.source="hacker-news"),"reddit"===HB.source?HB.Data.getRedditData(function(t){HB.Chart.drawStories(t)}):HB.Data.getHNStories(function(t){HB.Chart.drawStories(t)})}();