"use strict";var NB=NB||{};NB.DUR=200,NB.RESIZER_WIDTH=24,NB.splitPos=0,NB.AddedOnOtherBranch=1,NB.MIN_POINTS=1,NB.HITS_PER_PAGE=200,NB.POLL_PERIOD=3e5,NB.hasTouch=!0,NB.oldestStory=1/0,NB.Change3=3;var NB=NB||{};NB.Data=function(){function t(t,e){e=e||"commentCount",t.sort(function(t,n){return n[e]-t[e]})}function e(t){t.forEach(function(t){var e=c.stories.filter(function(e){return e.id===t.id})[0];e?(e.commentCount=t.commentCount,e.score=t.score):t.postDate>NB.oldestStory&&c.stories.push(t)})}function n(e){return e.forEach(function(t){t.postDate=new Date(t.postDate)}),t(e,"commentCount"),e}function o(e,n){return e.forEach(function(t){t.postDate=new Date(t.postDate),n&&(NB.oldestStory=Math.min(NB.oldestStory,t.postDate))}),t(e,"commentCount"),e}function r(t){t=t||NB.HITS_PER_PAGE,$.get("/api/hn/"+t,function(t){c.stories=o(t,!0),NB.Chart.drawStories()})}function a(t){t=t||NB.HITS_PER_PAGE,$.get("/api/rd/"+t,function(t){c.stories=o(t,!0),NB.Chart.drawStories()})}function i(){s=io(),s.on("data",function(t){t.data.length&&t.source===NB.source&&(e(n(t.data)),NB.Chart.drawStories())})}var s,c={},l={},d=[];return localStorage.readList&&(d=JSON.parse(localStorage.readList)),c.stories=[],c.setData=function(t,e){l[t]=e},c.markAsRead=function(t){d.push(t),localStorage.readList=JSON.stringify(d)},c.isRead=function(t){for(var e=t.toString(),n=0;n<d.length;n++)if(e===d[n])return!0;return!1},c.getData=function(t,e){"rd"===t&&a(e),"hn"===t&&r(e)},c.goBananas=function(){console.log("Get comfortable..."),$.get("/api/hn/getall",function(t){e(n(t)),console.log("Got",t.length,"stories"),NB.Chart.drawStories()})},i(),c}();var NB=NB||{};NB.Layout=function(){function t(){a.style("width",NB.splitPos+"px"),i.style("left",NB.splitPos+"px")}function e(){t(),a.style("display","block"),i.style("display","block")}function n(){s||(s=!0,d3.select("#story-panel-toggle").text("»"),NB.splitPos=.618*document.body.offsetWidth,t(),NB.Chart.resize(!0))}function o(e){(e||s)&&(s=!1,d3.select("#story-panel-toggle").text("«"),NB.splitPos=document.body.offsetWidth-NB.RESIZER_WIDTH,t(),NB.Chart.resize())}var r={},a=d3.select("#chart-wrapper"),i=d3.select("#story-panel"),s=!1;return r.render=function(){t(),document.body.offsetWidth-NB.splitPos<100&&o(!0),s||NB.splitPos+NB.RESIZER_WIDTH===document.body.offsetWidth||o(!0)},r.moveSplitPos=function(){s||(s=!0,d3.select("#story-panel-toggle").text("»")),t()},r.showStoryPanel=function(){n()},r.hideStoryPanel=function(){o()},r.toggleStoryPanel=function(){s?o():n()},r.init=function(){e()},r}();var NB=NB||{};NB.Chart=function(){function t(t){var e=d3.select(d3.event.currentTarget);d3.select(".selected").classed("read",!0).classed("selected",!1),e.classed("selected",!0),NB.Data.markAsRead(t.id),NB.Layout.showStoryPanel(),S.style("visibility","hidden"),NB.StoryPanel.render(t)}function e(t){var e=t.reddit?" - "+t.reddit.domain:"";S.text(t.name+e);var n=parseInt(S.style("width")),o=parseInt(S.style("height")),r=this.getBoundingClientRect(),a=r.left-(n-r.width)/2;a=Math.max(a,w.left),a=Math.min(a,N-w.right-n);var i=r.top-o;100>i&&(i=r.top+r.height),S.style("left",a+"px").style("top",i+"px").style("visibility","visible")}function n(){S.style("visibility","hidden")}function o(o){var r=d.selectAll("circle").data(NB.Data.stories,function(t){return t.id});r.classed("updating",!0),r.enter().append("circle").attr("r",function(t){return g(t.commentCount)}).attr("cx",function(){return h(C)}).attr("cy",function(){return m(0)}).classed("story-circle",!0).classed("read",function(t){return NB.Data.isRead(t.id)}).on("click",t).on("mouseover",e).on("mouseout",n);var a=0;o&&(a=NB.DUR),r.transition().duration(a).attr("r",function(t){return g(t.commentCount)}).attr("cx",function(t){return h(t.postDate)}).attr("cy",function(t){return m(t.score)})}function r(){B=parseInt(d3.select("#chart-wrapper").style("height"),10)-4,N=NB.splitPos,y.ticks(N-w.left-w.right<600?5:10),f=document.body.offsetHeight/20,w.top=40+f/2,l.attr("width",N).attr("height",B),p.attr("transform","translate("+w.left+","+w.top+")").attr("width",N-w.left-w.right).attr("height",B-w.top-w.bottom),u.attr("x",w.left).attr("y",0).attr("width",N-w.left).attr("height",B-w.bottom),h.range([40,N-20]),m.range([B-w.bottom-7,w.top]),g.range([7,f]),x.x(h),b.attr("transform","translate(0,"+(B-w.bottom)+")"),v.innerTickSize(-1*(N-w.left-w.right)),D.attr("transform","translate("+w.left+", 0)"),b.call(y),D.call(v),D.selectAll("text").attr("x",4).attr("dy",-4).style("text-anchor","start")}function a(){k=Math.min(k,d3.min(NB.Data.stories,function(t){return t.postDate})),C=Math.max(C,d3.max(NB.Data.stories,function(t){return t.postDate})),_=Math.max(_,d3.max(NB.Data.stories,function(t){return t.score})),I=Math.min(I,d3.min(NB.Data.stories,function(t){return t.commentCount})),E=Math.max(E,d3.max(NB.Data.stories,function(t){return t.commentCount})),h.domain([k,C]),m.domain([NB.MIN_POINTS,_]),g.domain([I,E]),x.x(h)}function i(){b.call(y),o()}function s(){x=d3.behavior.zoom().x(h).scaleExtent([1,1/0]).on("zoom",i)}function c(){l=d3.select("#svg-bubble-chart"),S=d3.select("#tooltip"),h=d3.time.scale(),m=d3.scale.pow().exponent(.5),g=d3.scale.pow().exponent(.5),y=d3.svg.axis().scale(h).ticks(8).tickSize(3,0),v=d3.svg.axis().scale(m).orient("left").ticks(15).tickSize(0,0);var t=l.append("g").classed("chart-axis",!0);b=t.append("g").classed("chart-axis-x",!0),D=t.append("g").classed("chart-axis-y",!0),s(),d=l.append("g").classed("chart-plot-area",!0).style("pointer-events","all").call(x),p=d.append("rect").attr("class","overlay"),p.on("touchstart.zoom",null),u=d3.select("#plot-area-clip rect")}var l,d,u,p,f,h,m,g,N,B,y,v,b,D,S,x,P={},w={top:70,right:0,bottom:30,left:0},k=1/0,C=0,_=0,I=1/0,E=0;return P.drawStories=function(){a(),r(),o(!0)},P.resize=function(t){NB.Data.stories.length&&(r(),a(),o(t))},c(),P}();var NB=NB||{};NB.Events=function(){function t(t){return"story-panel-toggle"===d3.event.target.id?!1:(console.log("#story-panel-resizer clicked:",t),r=d3.select("#chart-wrapper").style("transition","0ms"),o=d3.select("#story-panel").style("transition","0ms"),a=d3.select("#story-panel-resizer").classed("active",!0),s=d3.select("body"),i=d3.mouse(document.body)[0]-NB.splitPos,s.on("mousemove",e),s.on("mouseup",n),s.on("touchmove",e),void s.on("touchend",n))}function e(){d3.event.preventDefault(),NB.splitPos=Math.max(100,d3.mouse(document.body)[0]-i),NB.Layout.moveSplitPos(),NB.Chart.resize()}function n(){r.style("transition",null),o.style("transition",null),a.classed("active",!1),document.body.offsetWidth-NB.splitPos<100&&NB.Layout.hideStoryPanel(),s.on("mousemove",null),s.on("mouseup",null),s.on("touchmove",null),s.on("touchend",null)}var o,r,a,i,s,c={};return d3.select("#story-panel-resizer").on("mousedown",t),d3.select("#story-panel-resizer").on("touchstart",t),d3.select("#story-panel-toggle").on("click",function(){return console.log("#story-panel-toggle clicked"),d3.event.preventDefault(),NB.Layout.toggleStoryPanel(),!1}),$("#more-btn").on("click",function(){NB.Data.getNextPage(function(t){NB.Chart.addStories(t)})}),window.onresize=function(){NB.Layout.render(),NB.Chart.resize()},c}();var NB=NB||{};NB.StoryPanel=function(){function t(t,e){var n=$('<div class="story-content"></div>'),o="/readability/",r=t.url,a=o+encodeURIComponent(r);$.get(a,function(o){if(o.error){var r=["<h2>Oh no.</h2>","<p>This article could not be fetched. You can visit the full page ",'<a href="'+t.url+'" target="_blank">here</a>.',"</p>"].join("");e(n.append(r))}else e(n.append(o.content))})}function e(e,n){var o=e.reddit.domain.toLowerCase(),r=$('<div class="story-title"></div>');if(r.append('<div class="story-title"><h1><a class="title" href="'+e.url+'" target="_blank">'+e.name+"</a></h1></div>"),r.append("<hr>"),e.reddit.self){var a=['<div class="story-content">',e.reddit.selftext+"<br>","<p>Built-in reddit comments coming soon. For now, head over to ",'<a href="'+e.url+'" target="_blank">reddit to read more</a>.',"</p>","</div>"].join("");return r.append(a),void n.append(r)}if("i.imgur.com"===o||"imgur.com"===o){var i=e.url.replace("imgur.com","i.imgur.com")+".jpg",a=['<div class="story-content">',"<p>Embedded imgur magic coming soon.<br>",'<a href="'+e.url+'" target="_blank"><img src="'+i+'"></a>',"<br>",'<a href="'+e.url+'" target="_blank">Go to imgur.</a>.',"</p>","</div>"].join("");return r.append(a),void n.append(r)}return e.url.match(/\.(gif|png|jpg)\?*.*$/)?(r.append('<a href="'+e.url+'" target="_blank"><img src="'+e.url+'"></a>'),void n.append(r)):void t(e,function(t){r.append(t),n.append(r)})}function n(e,n){var o=$('<div class="story-title"></div>'),a=$('<div class="story-content"></div>'),i='<p class="sub-title">';if(e.url){o.append('<h1><a class="title" href="'+e.url+'" target="_blank">'+e.name+"</a></h1>");var s=e.url.match(/:\/\/([^\/]*)/);i+=s[1]?s[1]+"<br>":""}else o.append("<h1>"+e.name+"</h1>");return i+=Math.round(e.score)+" points | ",i+='<a href="https://news.ycombinator.com/item?id='+e.sourceId+'" target="_blank">',i+=e.commentCount+" comments</a> | ",i+='posted by <a href="https://news.ycombinator.com/user?id='+e.author+'" target="_blank">'+e.author+"</a><br>",i+=r(e.postDate)+"</p>",o.append(i),n.append(o),n.append("<hr>"),e.url?void t(e,function(t){a.append(t),n.append(a)}):(a.append(e.story_text),void n.append(a))}var o={},r=d3.time.format("%-I:%M%p on %A, %-e %B %Y");return o.render=function(t){var o=$("#story-panel-content").empty();"rd"===t.source&&e(t,o),"hn"===t.source&&n(t,o)},o}();var NB=NB||{};NB.main=function(){NB.splitPos=document.body.offsetWidth-NB.RESIZER_WIDTH,NB.Layout.render(),NB.Layout.init(),NB.source="rd";var t=document.location.search.replace("?src=","");"rd"===t?NB.source="rd":"hn"===t&&(NB.source="hn"),NB.Data.getData(NB.source,200),"ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch||(d3.select("body").classed("no-touch",!0),NB.hasTouch=!1)}();