"use strict";var NB=NB||{};NB.DUR=200,NB.RESIZER_WIDTH=24,NB.splitPos=0,NB.AddedOnOtherBranch=1,NB.MIN_POINTS=1,NB.HITS_PER_PAGE=200,NB.POLL_PERIOD=3e5,NB.hasTouch=!0,NB.oldestStory=1/0,NB.Change3=3;var NB=NB||{};NB.Data=function(){function t(t,e){e=e||"commentCount",t.sort(function(t,o){return o[e]-t[e]})}function e(t){t.forEach(function(t){var e=c.stories.filter(function(e){return e.id===t.id})[0];e?(e.commentCount=t.commentCount,e.score=t.score):t.postDate>NB.oldestStory&&c.stories.push(t)})}function o(e){return e.forEach(function(t){t.postDate=new Date(t.postDate)}),t(e,"commentCount"),e}function n(e,o){return e.forEach(function(t){t.postDate=new Date(t.postDate),o&&(NB.oldestStory=Math.min(NB.oldestStory,t.postDate))}),t(e,"commentCount"),e}function r(t){t=t||NB.HITS_PER_PAGE,$.get("/api/hn/"+t,function(t){c.stories=n(t,!0),NB.Chart.drawStories()})}function a(t){t=t||NB.HITS_PER_PAGE,$.get("/api/rd/"+t,function(t){c.stories=n(t,!0),NB.Chart.drawStories()})}function s(){i=io(),i.on("data",function(t){t.data.length&&t.source===NB.source&&(e(o(t.data)),NB.Chart.drawStories())})}var i,c={},l={},u=[];return localStorage.readList&&(u=JSON.parse(localStorage.readList)),c.stories=[],c.tooltipStory={name:ko.observable("some name"),url:ko.observable("some url"),storyUrl:ko.observable(),domain:ko.observable("some domain"),author:ko.observable("hot ferret"),commentCount:ko.observable("some commentCount"),score:ko.observable("some score"),timeString:ko.observable("some timeString"),dateString:ko.observable("hot dateString")},c.panelStory={name:ko.observable("News Bubbles"),url:ko.observable(),storyUrl:ko.observable(),domain:ko.observable(),author:ko.observable(),commentCount:ko.observable(),score:ko.observable(),timeString:ko.observable(),dateString:ko.observable(),content:ko.observable("Select a bubble on the left do display its content here.")},c.setCurrentStory=function(t,e){var o,n,r=c[t+"Story"],a=d3.time.format("%a, %-e %b %Y"),s=d3.time.format("%-I:%M%p"),i=e.name;if("rd"===e.source&&(o=e.reddit.domain),"hn"===e.source)if(n="https://news.ycombinator.com/item?id="+e.sourceId,e.name.toLowerCase().indexOf("show hn")>-1)o="Show HN",i=i.replace("Show HN: ","");else if(e.name.toLowerCase().indexOf("ask hn")>-1)o="Ask HN",i=i.replace("Ask HN: ","");else{var l=e.url.match(/:\/\/([^\/]*)/);o=l[1]?l[1]:"HN"}"tooltip"===t&&i.length>50&&(i=i.substr(0,47).trim()+"..."),r.name(i).url(e.url).storyUrl(n).domain(o).author(e.author).commentCount(e.commentCount).score(Math.round(e.score)).timeString(s(e.postDate)).dateString(a(e.postDate)),"panel"===t&&r.content(e.content)},c.setData=function(t,e){l[t]=e},c.markAsRead=function(t){u.push(t),localStorage.readList=JSON.stringify(u)},c.markAsUnread=function(t){t=t.toString();for(var e=0;e<u.length;e++)if(u[e]===t)return u.splice(e,1),void(localStorage.readList=JSON.stringify(u))},c.isRead=function(t){for(var e=t.toString(),o=!1,n=0;n<u.length;n++)e===u[n]&&(o=!0);return o},c.getData=function(t,e){"rd"===t&&a(e),"hn"===t&&r(e)},s(),c}();var NB=NB||{};NB.Layout=function(){function t(){a.style("width",NB.splitPos+"px"),s.style("left",NB.splitPos+"px")}function e(){t(),a.style("display","block"),s.style("display","block")}function o(){i||(i=!0,d3.select("#story-panel-toggle").text("»"),NB.splitPos=.618*document.body.offsetWidth,t(),NB.Chart.resize(!0))}function n(e){(e||i)&&(i=!1,d3.select("#story-panel-toggle").text("«"),NB.splitPos=document.body.offsetWidth-NB.RESIZER_WIDTH,t(),NB.Chart.resize())}var r={},a=d3.select("#chart-wrapper"),s=d3.select("#story-panel"),i=!1;return r.render=function(){t(),document.body.offsetWidth-NB.splitPos<100&&n(!0),i||NB.splitPos+NB.RESIZER_WIDTH===document.body.offsetWidth||n(!0)},r.moveSplitPos=function(){i||(i=!0,d3.select("#story-panel-toggle").text("»")),t()},r.showStoryPanel=function(){o()},r.hideStoryPanel=function(){n()},r.toggleStoryPanel=function(){i?n():o()},r.init=function(){e()},r}();var NB=NB||{};NB.Chart=function(){function t(t){var e=d3.select(d3.event.currentTarget);d3.select(".selected").classed("selected",!1),e.classed("selected",!0).classed("read",!0),NB.Data.isRead(t.id)||NB.Data.markAsRead(t.id),NB.Layout.showStoryPanel(),k.style("visibility","hidden"),NB.StoryPanel.render(t)}function e(t){var e=t.reddit?" - "+t.reddit.domain:"";k.text(t.name+e);var o=parseInt(k.style("width")),n=parseInt(k.style("height")),r=this.getBoundingClientRect(),a=r.left-(o-r.width)/2;a=Math.max(a,C.left),a=Math.min(a,B-C.right-o);var s=r.top-n;100>s&&(s=r.top+r.height),k.style("left",a+"px").style("top",s+"px").style("visibility","visible")}function o(){k.style("visibility","hidden")}function n(t){d3.event.preventDefault();var e=d3.select(d3.event.currentTarget);e.classed("read")?(e.classed("read",!1),NB.Data.markAsUnread(t.id)):(e.classed("read",!0),NB.Data.markAsRead(t.id))}function r(r){var a=d.selectAll("circle").data(NB.Data.stories,function(t){return t.id});a.classed("updating",!0),a.enter().append("circle").attr("r",function(t){return g(t.commentCount)}).attr("cx",function(){return p(I)}).attr("cy",function(){return N(0)}).classed("story-circle",!0).classed("read",function(t){return NB.Data.isRead(t.id)}).on("click",t).on("mouseover",e).on("mouseout",o).on("contextmenu",n);var s=0;r&&(s=NB.DUR),a.transition().duration(s).attr("r",function(t){return g(t.commentCount)}).attr("cx",function(t){return p(t.postDate)}).attr("cy",function(t){return N(t.score)})}function a(){y=parseInt(d3.select("#chart-wrapper").style("height"),10)-4,B=NB.splitPos,v.ticks(B-C.left-C.right<600?5:10),h=document.body.offsetHeight/20,C.top=40+h/2,u.attr("width",B).attr("height",y),f.attr("transform","translate("+C.left+","+C.top+")").attr("width",B-C.left-C.right).attr("height",y-C.top-C.bottom),m.attr("x",C.left).attr("y",0).attr("width",B-C.left).attr("height",y-C.bottom),p.range([40,B-20]),N.range([y-C.bottom-7,C.top]),g.range([10,h]),x.x(p),S.attr("transform","translate(0,"+(y-C.bottom)+")"),b.innerTickSize(-1*(B-C.left-C.right)),D.attr("transform","translate("+C.left+", 0)"),S.call(v),D.call(b),D.selectAll("text").attr("x",4).attr("dy",-4).style("text-anchor","start")}function s(){P=Math.min(P,d3.min(NB.Data.stories,function(t){return t.postDate})),I=Math.max(I,d3.max(NB.Data.stories,function(t){return t.postDate})),E=Math.max(E,d3.max(NB.Data.stories,function(t){return t.score})),R=Math.min(R,d3.min(NB.Data.stories,function(t){return t.commentCount})),T=Math.max(T,d3.max(NB.Data.stories,function(t){return t.commentCount})),p.domain([P,I]),N.domain([NB.MIN_POINTS,E]),g.domain([R,T]),x.x(p)}function i(){S.call(v),r()}function c(){x=d3.behavior.zoom().x(p).scaleExtent([1,1/0]).on("zoom",i)}function l(){u=d3.select("#svg-bubble-chart"),k=d3.select("#tooltip"),p=d3.time.scale(),N=d3.scale.pow().exponent(.3),g=d3.scale.pow().exponent(.5),v=d3.svg.axis().scale(p).ticks(8).tickSize(3,0),b=d3.svg.axis().scale(N).orient("left").ticks(15).tickSize(0,0);var t=u.append("g").classed("chart-axis",!0);S=t.append("g").classed("chart-axis-x",!0),D=t.append("g").classed("chart-axis-y",!0),c(),d=u.append("g").classed("chart-plot-area",!0).style("pointer-events","all").call(x),f=d.append("rect").attr("class","overlay"),f.on("touchstart.zoom",null),m=d3.select("#plot-area-clip rect")}var u,d,m,f,h,p,N,g,B,y,v,b,S,D,k,x,w={},C={top:70,right:0,bottom:30,left:0},P=1/0,I=0,E=0,R=1/0,T=0;return w.drawStories=function(){s(),a(),r(!0)},w.resize=function(t){NB.Data.stories.length&&(a(),s(),r(t))},l(),w}();var NB=NB||{};NB.Events=function(){function t(t){return"story-panel-toggle"===d3.event.target.id?!1:(console.log("#story-panel-resizer clicked:",t),r=d3.select("#chart-wrapper").style("transition","0ms"),n=d3.select("#story-panel").style("transition","0ms"),a=d3.select("#story-panel-resizer").classed("active",!0),i=d3.select("body"),s=d3.mouse(document.body)[0]-NB.splitPos,i.on("mousemove",e),i.on("mouseup",o),i.on("touchmove",e),void i.on("touchend",o))}function e(){d3.event.preventDefault(),NB.splitPos=Math.max(100,d3.mouse(document.body)[0]-s),NB.Layout.moveSplitPos(),NB.Chart.resize()}function o(){r.style("transition",null),n.style("transition",null),a.classed("active",!1),document.body.offsetWidth-NB.splitPos<100&&NB.Layout.hideStoryPanel(),i.on("mousemove",null),i.on("mouseup",null),i.on("touchmove",null),i.on("touchend",null)}var n,r,a,s,i,c={};return d3.select("#story-panel-resizer").on("mousedown",t),d3.select("#story-panel-resizer").on("touchstart",t),d3.select("#story-panel-toggle").on("click",function(){return d3.event.preventDefault(),NB.Layout.toggleStoryPanel(),!1}),$("#more-btn").on("click",function(){NB.Data.getNextPage(function(t){NB.Chart.addStories(t)})}),window.onresize=function(){NB.Layout.render(),NB.Chart.resize()},c}();var NB=NB||{};NB.StoryPanel=function(){function t(t,e){var o=($('<div class="story-content"></div>'),"/readability/"),n=t.url,r=o+encodeURIComponent(n);$.get(r,function(o){if(o.error){var n=["<h2>Oh no.</h2>","<p>This article could not be fetched. You can visit the full page ",'<a href="'+t.url+'" target="_blank">here</a>.',"</p>"].join("");e(n)}else e(o.content)})}function e(e){function o(){NB.Data.setCurrentStory("panel",e)}var n=e.reddit.domain.toLowerCase();if(e.reddit.self){var r=["<p>Built-in reddit comments coming soon. For now, head over to ",'<a href="'+e.url+'" target="_blank">reddit to read more</a>.',"</p>"].join("");e.content=r,o()}else if(e.url.match(/\.(gif|png|jpg)\?*.*$/))e.content='<img src="'+e.url+'">',o();else if("i.imgur.com"===n||"imgur.com"===n||"m.imgur.com"===n)if(e.url.match(/\imgur\.com\/a\//)){var a=e.url.replace(/.*?\imgur\.com\/a\//,""),s="https://api.imgur.com/3/album/"+a+"/images",r="";$.get(s,function(t){r+='<div class="story-content">',t.data.forEach(function(t){r+='<img src="'+t.link+'"><br>'}),r+="</div>",e.content=r,o()})}else{var i=e.url.replace("imgur.com","i.imgur.com")+".jpg";e.content=['<div class="story-content">','<a href="'+e.url+'" target="_blank"><img src="'+i+'"></a>',"<br>",'<a href="'+e.url+'" target="_blank">Go to imgur.</a>.',"</div>"].join(""),o()}else t(e,function(t){e.content=t,o()})}function o(e){e.url?e.url.match(/pdf\?*.*$/)?(e.content='<a href="'+e.url+'" target="_blank">Download/open this PDF</a>',NB.Data.setCurrentStory("panel",e)):t(e,function(t){e.content=t,NB.Data.setCurrentStory("panel",e)}):(console.log("This story has no conent:",e),e.content="Built-in Hacker News comments coming soon.",NB.Data.setCurrentStory("panel",e))}{var n={};d3.time.format("%-I:%M%p on %A, %-e %B %Y")}return n.render=function(t){"rd"===t.source&&e(t),"hn"===t.source&&o(t)},n}();var NB=NB||{};NB.main=function(){NB.splitPos=document.body.offsetWidth-NB.RESIZER_WIDTH,NB.Layout.render(),NB.Layout.init(),NB.source="rd";var t=document.location.search.replace("?src=","");"rd"===t?NB.source="rd":"hn"===t&&(NB.source="hn"),NB.Data.getData(NB.source,200),ko.applyBindings(NB.Data.tooltipStory,document.getElementById("story-tooltip")),ko.applyBindings(NB.Data.panelStory,document.getElementById("story-panel")),"ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch||(d3.select("body").classed("no-touch",!0),NB.hasTouch=!1)}();