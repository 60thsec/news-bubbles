"use strict";var HB=HB||{};HB.DUR=200,HB.RESIZER_WIDTH=24,HB.splitPos=0,HB.MIN_POINTS=1,HB.HITS_PER_PAGE=200,HB.POLL_PERIOD=3e5;var HB=HB||{};HB.Data=function(){function t(t,e){e=e||"commentCount",t.sort(function(t,o){return o[e]-t[e]})}function e(e){return e.forEach(function(t){var e=new Date(t.created_at);t.postDate=e;var o=t.num_comments;t.commentCount=o,t.name=t.title,t.score=t.points,t.id="hn-"+t.objectID}),t(e,"commentCount"),e}function o(e){return e.forEach(function(t){var e=new Date(t.postDate);t.postDate=e}),t(e,"commentCount"),e}function n(e){return e.forEach(function(t){var e=new Date(t.data.created);t.postDate=e;var o=t.data.num_comments;t.commentCount=o,t.score=t.data.score,t.id="rd-"+t.data.name,t.name=t.data.title,t.url=t.data.url,t.author=t.data.author,t.thumb=t.data.thumbnail}),t(e,"commentCount"),console.log("parsed reddit data:",e),e}function a(t){t.forEach(function(t){var e=d.stories.filter(function(e){return e.id===t.id})[0];e?(console.log("Updated",e),e.commentCount=t.commentCount,e.score=t.score):(console.log("Added new:",t),d.stories.push(t))})}function r(t){var o="search_by_date?";o+="tags=(story,show_hn,ask_hn)",o+="&hitsPerPage="+HB.HITS_PER_PAGE,o+="&numericFilters=points>="+HB.MIN_POINTS,$.get("https://hn.algolia.com/api/v1/"+o,function(o){console.log("Updated data at",Date()),o=o.hits,d.stories=e(o),t()})}function s(t){var e="http://www.reddit.com/hot.json?limit=100";$.get(e,function(e){console.log("got data from reddit:",e),e=e.data.children,d.stories=n(e),t()})}function i(){l=io(),l.on("data",function(t){if(console.log("Got data from:",t.source),console.log(t.data),t.data.length&&t.source===HB.source){var e=o(t.data);a(e),HB.Chart.drawStories()}})}var c,l,d={},u={},m=[];return localStorage.readList&&(m=JSON.parse(localStorage.readList)),d.stories=[],d.setData=function(t,e){u[t]=e},d.markAsRead=function(t){m.push(t),localStorage.readList=JSON.stringify(m)},d.isRead=function(t){for(var e=t.toString(),o=0;o<m.length;o++)if(e===m[o])return!0;return!1},d.getRedditData=function(t){s(t,!1)},d.getHNStories=function(t){r(t,!1)},d.stopPolling=function(){window.clearInterval(c)},i(),d}();var HB=HB||{};HB.Layout=function(){function t(){r.style("width",HB.splitPos+"px"),s.style("left",HB.splitPos+"px")}function e(){t(),r.style("display","block"),s.style("display","block")}function o(){i||(i=!0,d3.select("#story-panel-toggle").text("»"),HB.splitPos=.618*document.body.offsetWidth,t(),HB.Chart.resize(!0))}function n(e){(e||i)&&(i=!1,d3.select("#story-panel-toggle").text("«"),HB.splitPos=document.body.offsetWidth-HB.RESIZER_WIDTH,t(),HB.Chart.resize())}var a={},r=d3.select("#chart-wrapper"),s=d3.select("#story-panel"),i=!1;return a.render=function(){t(),document.body.offsetWidth-HB.splitPos<100&&n(!0),i||HB.splitPos+HB.RESIZER_WIDTH===document.body.offsetWidth||n(!0)},a.moveSplitPos=function(){i||(i=!0,d3.select("#story-panel-toggle").text("»")),t()},a.showStoryPanel=function(){o()},a.hideStoryPanel=function(){n()},a.toggleStoryPanel=function(){i?n():o()},a.init=function(){e()},a}();var HB=HB||{};HB.Chart=function(){function t(t){var e=d3.select(d3.event.currentTarget);d3.select(".selected").classed("read",!0).classed("selected",!1),e.classed("selected",!0),HB.Data.markAsRead(t.id),HB.Layout.showStoryPanel(),$("#story-content").html(""),P.style("visibility","hidden");var o="";if(t.url){if(o+='<h1><a class="title" href="'+t.url+'" target="_blank">'+t.name+"</a></h1>",t.data&&t.data.is_self){$("#story-title").html(o);var n=[t.data.selftext+"<hr>","<p>Built-in reddit comments coming soon. For now, head over to ",'<a href="'+t.url+'" target="_blank">reddit to read more</a>.',"</p>"].join("");return void $("#story-content").html(n)}if(t.url.match(/\.(gif|png|jpg)\?*.*$/))return $("#story-title").html(o),void $("#story-content").html('<a href="'+t.url+'" target="_blank"><img src="'+t.url+'"></a>');if(t.data&&"imgur.com"===t.data.domain){var a=t.url.replace("imgur.com","i.imgur.com")+".jpg";$("#story-title").html(o);var n=["<p>Embedded imgur magic coming soon.",'<a href="'+t.url+'" target="_blank"><img src="'+a+'"></a>',"<br>",'<a href="'+t.url+'" target="_blank">Go to imgur.</a>.',"</p>"].join("");return void $("#story-content").html(n)}}else o+="<h1>"+t.name+"</h1>";if(o+='<p class="sub-title">'+Math.round(t.score)+" points | ","hn"===HB.source&&(o+='<a href="https://news.ycombinator.com/item?id='+t.id+'" target="_blank">'+t.commentCount+" comments</a> | "),o+="posted by "+t.author+"</p>",t.url){var r="/readability/",s=t.url,i=r+encodeURIComponent(s);$.get(i,function(e){if(e.error){var o=["<h2>Oh no.</h2>","<p>This article could not be fetched. You can visit the full page ",'<a href="'+t.url+'" target="_blank">here</a>.',"</p>"].join("");$("#story-content").html(o)}$("#story-content").html(e.content)})}else $("#story-content").html(t.story_text);$("#story-title").html(o)}function e(t){P.text(t.name);var e=parseInt(P.style("width")),o=parseInt(P.style("height")),n=this.getBoundingClientRect(),a=n.left-(e-n.width)/2;a=Math.max(a,_.left),a=Math.min(a,y-_.right-e);var r=n.top-o;100>r&&(r=n.top+n.height),P.style("left",a+"px").style("top",r+"px").style("visibility","visible")}function o(){P.style("visibility","hidden")}function n(n){var a=d.selectAll("circle").data(HB.Data.stories,function(t){return t.id});a.classed("updating",!0),a.enter().append("circle").attr("r",function(t){return g(t.commentCount)}).attr("cx",function(){return h(k)}).attr("cy",function(){return p(0)}).classed("story-circle",!0).classed("read",function(t){return HB.Data.isRead(t.id)}).on("click",t).on("mouseover",e).on("mouseout",o);var r=0;n&&(r=HB.DUR),a.transition().duration(r).attr("r",function(t){return g(t.commentCount)}).attr("cx",function(t){return h(t.postDate)}).attr("cy",function(t){return p(t.score)})}function a(){H=parseInt(d3.select("#chart-wrapper").style("height"),10)-4,y=HB.splitPos,B.ticks(y-_.left-_.right<600?5:10),f=document.body.offsetHeight/20,l.attr("width",y).attr("height",H),m.attr("transform","translate("+_.left+","+_.top+")").attr("width",y-_.left-_.right).attr("height",H-_.top-_.bottom),u.attr("x",_.left).attr("y",0).attr("width",y-_.left).attr("height",H-_.bottom),h.range([40,y-20]),p.range([H-_.bottom-7,_.top]),g.range([7,f]),S.x(h),b.attr("transform","translate(0,"+(H-_.bottom)+")"),v.innerTickSize(-1*(y-_.left-_.right)),x.attr("transform","translate("+_.left+", 0)"),b.call(B),x.call(v),x.selectAll("text").attr("x",4).attr("dy",-4).style("text-anchor","start")}function r(){C=Math.min(C,d3.min(HB.Data.stories,function(t){return t.postDate})),k=Math.max(k,d3.max(HB.Data.stories,function(t){return t.postDate})),I=Math.max(I,d3.max(HB.Data.stories,function(t){return t.score})),R=Math.min(R,d3.min(HB.Data.stories,function(t){return t.commentCount})),E=Math.max(E,d3.max(HB.Data.stories,function(t){return t.commentCount})),h.domain([C,k]),p.domain([HB.MIN_POINTS,I]),g.domain([R,E]),S.x(h)}function s(){b.call(B),n()}function i(){S=d3.behavior.zoom().x(h).scaleExtent([1,100]).on("zoom",s)}function c(){l=d3.select("#svg-bubble-chart"),P=d3.select("#tooltip"),h=d3.time.scale(),p=d3.scale.pow().exponent(.5),g=d3.scale.pow().exponent(.5),B=d3.svg.axis().scale(h).ticks(8).tickSize(3,0),v=d3.svg.axis().scale(p).orient("left").ticks(15).tickSize(0,0);var t=l.append("g").classed("chart-axis",!0);b=t.append("g").classed("chart-axis-x",!0),x=t.append("g").classed("chart-axis-y",!0),D=x.append("text").style("font-size","13px").text("Points").attr("transform","translate(0, 53)"),i(),d=l.append("g").classed("chart-plot-area",!0).style("pointer-events","all").call(S),m=d.append("rect").attr("class","overlay"),m.on("touchstart.zoom",null),u=d3.select("#plot-area-clip rect")}var l,d,u,m,f,h,p,g,y,H,B,v,b,x,D,P,S,w={},_={top:70,right:0,bottom:30,left:0},C=1/0,k=0,I=0,R=1/0,E=0;return w.drawStories=function(){r(),a(),n(!0)},w.resize=function(t){HB.Data.stories.length&&(a(),r(),n(t))},c(),w}();var HB=HB||{};HB.Events=function(){function t(t){return"story-panel-toggle"===d3.event.target.id?!1:(console.log("#story-panel-resizer clicked:",t),a=d3.select("#chart-wrapper").style("transition","0ms"),n=d3.select("#story-panel").style("transition","0ms"),r=d3.select("#story-panel-resizer").classed("active",!0),i=d3.select("body"),s=d3.mouse(document.body)[0]-HB.splitPos,i.on("mousemove",e),i.on("mouseup",o),i.on("touchmove",e),void i.on("touchend",o))}function e(){d3.event.preventDefault(),HB.splitPos=Math.max(100,d3.mouse(document.body)[0]-s),HB.Layout.moveSplitPos(),HB.Chart.resize()}function o(){a.style("transition",null),n.style("transition",null),r.classed("active",!1),document.body.offsetWidth-HB.splitPos<100&&HB.Layout.hideStoryPanel(),i.on("mousemove",null),i.on("mouseup",null),i.on("touchmove",null),i.on("touchend",null)}var n,a,r,s,i,c={};return d3.select("#story-panel-resizer").on("mousedown",t),d3.select("#story-panel-resizer").on("touchstart",t),d3.select("#story-panel-toggle").on("click",function(){return console.log("#story-panel-toggle clicked"),d3.event.preventDefault(),HB.Layout.toggleStoryPanel(),!1}),$("#more-btn").on("click",function(){HB.Data.getNextPage(function(t){HB.Chart.addStories(t)})}),window.onresize=function(){HB.Layout.render(),HB.Chart.resize()},c}();var HB=HB||{};HB.main=function(){HB.splitPos=document.body.offsetWidth-HB.RESIZER_WIDTH,HB.Layout.render(),HB.Layout.init(),HB.source="rd";var t=document.location.search.replace("?src=","");"rd"===t?HB.source="rd":"hn"===t&&(HB.source="hn"),"rd"===HB.source?HB.Data.getRedditData(function(t){HB.Chart.drawStories(t)}):HB.Data.getHNStories(function(){HB.Chart.drawStories()})}();