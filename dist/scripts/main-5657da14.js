"use strict";var NB=NB||{};NB.Utils=function(){var t={};return t.constrain=function(t,e,o){return e=Math.max(t,e),e=Math.min(e,o)},t}();var NB=NB||{};NB.Settings=function(){function t(){if(localStorage.settings){var t=JSON.parse(localStorage.settings);t.clickAction&&r.clickAction(t.clickAction),t.rightClickAction&&r.rightClickAction(t.rightClickAction),t.source&&r.source(t.source),t.hitLimit&&r.hitLimit(+t.hitLimit),t.rdMinScore&&r.rdMinScore(+t.rdMinScore),t.hnMinScore&&r.hnMinScore(+t.hnMinScore)}}function e(){r={clickAction:ko.observable("storyPanel"),rightClickAction:ko.observable("toggleRead"),source:ko.observable("rd"),hitLimit:ko.observable(200),rdMinScore:ko.observable(500),hnMinScore:ko.observable(5),hnCategoryColors:ko.observableArray([{category:"Ask HN",color:"#e74c3c"},{category:"Show HN",color:"#16a085"},{category:"Everything else",color:"#2980b9"}]),rdCategoryColors:ko.observableArray([{category:"AskReddit",color:"#2980b9"},{category:"funny",color:"#2ecc71"},{category:"pics",color:"#f39c12"},{category:"aww",color:"#8e44ad"},{category:"videos",color:"#e74c3c"},{category:"Everything else",color:"#7f8c8d"}])},a=$("#settings-wrapper"),ko.applyBindings(r,a[0]),t()}function o(){a.fadeOut(100)}function n(){var t=NB.Utils.constrain(1,r.hitLimit(),500);r.hitLimit(t);var t=Math.max(0,r.rdMinScore());r.rdMinScore(t);var t=Math.max(0,r.hnMinScore());r.hnMinScore(t);var e={clickAction:r.clickAction(),rightClickAction:r.rightClickAction(),source:r.source(),hitLimit:r.hitLimit(),rdMinScore:r.rdMinScore(),hnMinScore:r.hnMinScore()},n={};localStorage.settings&&(n=JSON.parse(localStorage.settings)),r.hitLimit()!==n.hitLimit&&(NB.Chart.reset(),NB.Data.getData());var a=r.source();r[a+"MinScore"]()!==n[a+"MinScore"]&&(NB.Chart.reset(),NB.Data.getData()),localStorage.settings=JSON.stringify(e),o()}var r,a,i={};return i.openSettings=function(){a.fadeIn(100)},i.saveSettings=function(){n()},i.cancelSettings=function(){t(),o()},i.getSetting=function(t){return r[t]()},i.setSetting=function(t,e){r[t](e),n()},i.getColor=function(t,e){for(var o,n=r[t+"CategoryColors"](),a=0;a<n.length;a++){if(n[a].category===e)return n[a].color;"Everything else"===n[a].category&&(o=n[a].color)}return o},e(),i}();var NB=NB||{};NB.DUR=200,NB.RESIZER_WIDTH=24,NB.splitPos=0,NB.IS_LOCALHOST=document.location.host.match(/localhost/)?!0:!1,NB.hasTouch=!0,NB.oldestStory=1/0;var NB=NB||{};NB.Data=function(){function t(t,e){e=e||"commentCount",t.sort(function(t,o){return o[e]-t[e]})}function e(t){var e=NB.Settings.getSetting("source"),o=NB.Settings.getSetting(e+"MinScore");t.forEach(function(t){var e=c.stories.filter(function(e){return e.id===t.id})[0];e?(e.commentCount=t.commentCount,e.score=t.score):t.postDate>NB.oldestStory&&t.score>o&&c.stories.push(t)})}function o(e){return e.forEach(function(t){t.postDate=new Date(t.postDate)}),t(e,"commentCount"),e}function n(e,o,n){e.forEach(function(t){t.postDate=new Date(t.postDate),o&&(NB.oldestStory=Math.min(NB.oldestStory,t.postDate))}),t(e,"commentCount"),n(e)}function r(t){var e=NB.Settings.getSetting("hitLimit");$.get("/api/hn/"+e+"/"+t,function(t){"hn"===NB.Settings.getSetting("source")&&t.length&&n(t,!0,function(t){c.stories=t,NB.Chart.drawStories()})})}function a(t){var e=NB.Settings.getSetting("hitLimit");$.get("/api/rd/"+e+"/"+t,function(t){"rd"===NB.Settings.getSetting("source")&&t.length&&n(t,!0,function(t){c.stories=t,NB.Chart.drawStories()})})}function i(){s=io(),s.on("data",function(t){if(c.stories.length){var n=NB.Settings.getSetting("source")||"rd";t.data.length&&t.source===n&&(e(o(t.data)),NB.Chart.drawStories())}})}var s,c={},l={},u=[];return localStorage.readList&&(u=JSON.parse(localStorage.readList)),c.stories=[],c.setData=function(t,e){l[t]=e},c.markAsRead=function(t){u.push(t),localStorage.readList=JSON.stringify(u)},c.markAsUnread=function(t){t=t.toString();for(var e=0;e<u.length;e++)if(u[e]===t)return u.splice(e,1),void(localStorage.readList=JSON.stringify(u))},c.isRead=function(t){for(var e=t.toString(),o=!1,n=0;n<u.length;n++)e===u[n]&&(o=!0);return o},c.getData=function(){var t=NB.Settings.getSetting("source")||"rd",e=NB.Settings.getSetting(t+"MinScore");"rd"===t&&a(e),"hn"===t&&r(e)},i(),c}();var NB=NB||{};NB.Layout=function(){function t(){a.style("width",NB.splitPos+"px"),i.style("left",NB.splitPos+"px")}function e(){t(),a.style("display","block"),i.style("display","block")}function o(){s||(s=!0,d3.select("#story-panel-toggle").text("»"),NB.splitPos=.618*document.body.offsetWidth,t(),NB.Chart.resize(!0))}function n(e){(e||s)&&(s=!1,d3.select("#story-panel-toggle").text("«"),NB.splitPos=document.body.offsetWidth-NB.RESIZER_WIDTH,t(),NB.Chart.resize(!0))}var r={},a=d3.select("#chart-wrapper"),i=d3.select("#story-panel"),s=!1;return r.render=function(){t(),document.body.offsetWidth-NB.splitPos<100&&n(!0),s||NB.splitPos+NB.RESIZER_WIDTH===document.body.offsetWidth||n(!0)},r.moveSplitPos=function(){s||(s=!0,d3.select("#story-panel-toggle").text("»")),t()},r.showStoryPanel=function(){o()},r.hideStoryPanel=function(){n()},r.toggleStoryPanel=function(){s?n():o()},r.init=function(){e()},r}();var NB=NB||{};NB.Chart=function(){function t(t,e){NB.Data.isRead(e.id)||(NB.Data.markAsRead(e.id),t.classed("read",!0))}function e(t,e){t.classed("read")?(t.classed("read",!1),NB.Data.markAsUnread(e.id)):(t.classed("read",!0),NB.Data.markAsRead(e.id))}function o(o){var n=d3.event.currentTarget;if(n.previousSibling){var r=n.parentNode,a=r.firstChild.nextSibling;r.insertBefore(n,a)}var i=d3.select(d3.event.currentTarget);d3.select(".selected").classed("selected",!1),i.classed("selected",!0);var s=NB.Settings.getSetting("clickAction");if("storyPanel"===s&&(t(i,o),NB.Layout.showStoryPanel(),NB.StoryPanel.render(o)),"storyTooltip"===s){var c=d3.select("#story-tooltip"),l=parseInt(c.style("width")),u=parseInt(c.style("height")),d=i.node().getBoundingClientRect(),g=S(o.commentCount),m=d.left+g-l/2,h=y-l-20;m=Math.min(m,h),m=Math.max(m,0);var f=d.top-u;50>f&&(f=d.bottom),NB.StoryModel.setCurrentStory("tooltip",o);var p=d3.select("#tooltip-mark-as-read");p.text(i.classed("read")?"Mark as unread":"Mark as read");var v=T?200:0;c.style("display","block").transition().duration(v).style("left",m+"px").style("top",f+"px"),T=!0,d3.event.stopPropagation(),$(document).on("click.tooltip",function(){c.style("display","none"),$(document).off("click.tooltip"),window.setTimeout(function(){T=!1},300)}),p.on("click",function(){e(i,o)}),d3.select("#tooltip-open-reading-pane").on("click",function(){t(i,o),NB.Layout.showStoryPanel(),NB.StoryPanel.render(o)})}w.style("visibility","hidden")}function n(t){if(!T){var e=" - "+t.category;w.text(t.name+e);var o=parseInt(w.style("width")),n=parseInt(w.style("height")),r=this.getBoundingClientRect(),a=r.left-(o-r.width)/2;a=Math.max(a,M.left),a=Math.min(a,y-M.right-o);var i=r.top-n;100>i&&(i=r.top+r.height),w.style("left",a+"px").style("top",i+"px").style("visibility","visible")}}function r(){w.style("visibility","hidden")}function a(t){var o=NB.Settings.getSetting("rightClickAction");if("nothing"!==o){d3.event.preventDefault();var n=d3.select(d3.event.currentTarget);e(n,t)}}function i(t){var e=m.selectAll("circle").data(NB.Data.stories,function(t){return t.id});e.classed("updating",!0),e.enter().append("circle").attr("r",function(t){return S(t.commentCount)}).attr("cx",function(){return p(A)}).attr("cy",function(){return v(0)}).attr("fill",function(t){return NB.Settings.getColor(t.source,t.category)}).attr("stroke",function(t){return NB.Settings.getColor(t.source,t.category)}).classed("story-circle",!0).classed("read",function(t){return NB.Data.isRead(t.id)}).on("click",o).on("mouseover",n).on("mouseout",r).on("contextmenu",a);var i=0;t&&(i=NB.DUR),e.transition().duration(i).attr("r",function(t){return S(t.commentCount)}).attr("cx",function(t){return p(t.postDate)}).attr("cy",function(t){return v(t.score)})}function s(){N=parseInt(d3.select("#chart-wrapper").style("height"),10)-4,y=NB.splitPos,B.ticks(y-M.left-M.right<600?5:10),f=document.body.offsetHeight/20,M.top=40+f/2,g.attr("width",y).attr("height",N),h.attr("transform","translate("+M.left+","+M.top+")").attr("width",y-M.left-M.right).attr("height",N-M.top-M.bottom),p.range([40,y-20]),v.range([N-M.bottom-7,M.top]),S.range([10,f]),x.x(p),k.attr("transform","translate(0,"+(N-M.bottom)+")"),b.innerTickSize(-1*(y-M.left-M.right)),C.attr("transform","translate("+M.left+", 0)"),k.call(B),C.call(b),C.selectAll("text").attr("x",4).attr("dy",-4).style("text-anchor","start")}function c(){var t=A,e=L;L=Math.min(L,d3.min(NB.Data.stories,function(t){return t.postDate})),A=Math.max(A,d3.max(NB.Data.stories,function(t){return t.postDate})),P=Math.max(P,d3.max(NB.Data.stories,function(t){return t.score})),I=Math.min(I,d3.min(NB.Data.stories,function(t){return t.commentCount})),R=Math.max(R,d3.max(NB.Data.stories,function(t){return t.commentCount})),(isNaN(I)||isNaN(R))&&(NB.IS_LOCALHOST||console.log("Something went wrong with this data:",NB.Data.stories));var o=NB.Settings.getSetting("source"),n=NB.Settings.getSetting(o+"MinScore");v.domain([n,P]),S.domain([I,R]),(e!==L||t!==A)&&(p.domain([L,A]),x.x(p))}function l(){k.call(B),i()}function u(){x=d3.behavior.zoom().x(p).on("zoom",l)}function d(){d3.selectAll("#svg-bubble-chart > *").remove(),g=d3.select("#svg-bubble-chart"),w=d3.select("#tooltip"),L=1/0,A=0,P=0,I=1/0,R=0,p=d3.time.scale(),v=d3.scale.pow().exponent(.3),S=d3.scale.pow().exponent(.5),B=d3.svg.axis().scale(p).ticks(8).tickSize(3,0),b=d3.svg.axis().scale(v).orient("left").ticks(15).tickSize(0,0);var t=g.append("g").classed("chart-axis",!0);k=t.append("g").classed("chart-axis-x",!0),C=t.append("g").classed("chart-axis-y",!0),u(),m=g.append("g").classed("chart-plot-area",!0).style("pointer-events","all").call(x),h=m.append("rect").attr("class","overlay"),h.on("touchstart.zoom",null)}var g,m,h,f,p,v,S,y,N,B,b,k,C,w,x,D={},M={top:70,right:0,bottom:30,left:0},L=1/0,A=0,P=0,I=1/0,R=0,T=!1;return D.drawStories=function(){c(),s(),i(!0)},D.reset=function(){d()},D.resize=function(t){NB.Data.stories.length&&(s(),c(),i(t))},d(),D}();var NB=NB||{};NB.Events=function(){function t(){return"story-panel-toggle"===d3.event.target.id?!1:(r=d3.select("#chart-wrapper").style("transition","0ms"),n=d3.select("#story-panel").style("transition","0ms"),a=d3.select("#story-panel-resizer").classed("active",!0),s=d3.select("body"),i=d3.mouse(document.body)[0]-NB.splitPos,s.on("mousemove",e),s.on("mouseup",o),s.on("touchmove",e),void s.on("touchend",o))}function e(){d3.event.preventDefault(),NB.splitPos=Math.max(100,d3.mouse(document.body)[0]-i),NB.Layout.moveSplitPos(),NB.Chart.resize()}function o(){r.style("transition",null),n.style("transition",null),a.classed("active",!1),document.body.offsetWidth-NB.splitPos<100&&NB.Layout.hideStoryPanel(),s.on("mousemove",null),s.on("mouseup",null),s.on("touchmove",null),s.on("touchend",null)}var n,r,a,i,s,c={};d3.select("#story-panel-resizer").on("mousedown",t),d3.select("#story-panel-resizer").on("touchstart",t),d3.select("#story-panel-toggle").on("click",function(){return d3.event.preventDefault(),NB.Layout.toggleStoryPanel(),!1}),$("#more-btn").on("click",function(){NB.Data.getNextPage(function(t){NB.Chart.addStories(t)})}),$("#open-settings-btn").on("click",function(){NB.Settings.openSettings()}),$("#save-settings-btn").on("click",function(){NB.Settings.saveSettings()}),$("#cancel-settings-btn").on("click",function(){NB.Settings.cancelSettings()});var l=$("#news-source-rd"),u=$("#news-source-hn");return l.on("click",function(){l.addClass("active"),u.removeClass("active"),NB.Settings.setSetting("source","rd"),NB.Chart.reset();var t=NB.Settings.getSetting("rdMinScore");NB.Data.getData("rd",t)}),u.on("click",function(){l.removeClass("active"),u.addClass("active"),NB.Settings.setSetting("source","hn"),NB.Chart.reset();var t=NB.Settings.getSetting("hnMinScore");NB.Data.getData("hn",t)}),window.onresize=function(){NB.Layout.render(),NB.Chart.resize()},c}();var NB=NB||{};NB.Comments=function(){function t(t,e){function o(t){s++;var e=$('<ul class="comment-list level-'+s+'">');return t.forEach(function(t){var i=$('<li class="comment-list-item">');if("more"===t.kind);else{n=t.data.author,r=moment(1e3*t.data.created_utc).fromNow(),a=t.data.score+" points";var s=$("<textarea>").html(t.data.body_html).text(),c=$('<div class="comment-list-item-text body"></div>');c.append(s),i.append(c),i.append('<p class="comment-list-item-text meta"> '+n+" | "+r+" | "+a+"</p>"),t.data.replies&&t.data.replies.data&&t.data.replies.data.children.length&&i.append(o(t.data.replies.data.children))}e.append(i)}),s--,e}var n,r,a,i=$("<div>"),s=0,c=t[0].data.children[0].data,l=$("<textarea>").html(c.selftext_html).text();l?(i.append(l),i.append("<h3>Comments</h3>"),i.append("<hr>")):i.append('<p class="comment-list-title">To contibute your own wisdom to the conversation, head on over to <a href="'+c.url+'" target="_blank">reddit</a>.</p><hr>'),i.append(o(t[1].data.children)),e(i)}function e(t,e,o){var n=$('<ul class="comment-list level-1"></ul>'),r="https://news.ycombinator.com/item?id="+t.sourceId;t.hn.storyText&&(n.append(t.hn.storyText),n.append("<h3>Comments</h3>"),n.append("<hr>"));var a=['<p class="comment-list-title">Head on over to ','<a href="'+r+'" target="_blank">Hacker News</a> to add yours.',"</p><hr>"].join("");n.append(a),e.hits.forEach(function(t){var e=$('<li class="comment-list-item">'),o=t.author,r=moment(1e3*t.created_at_i).fromNow(),a=t.points+" points";e.append('<div class="comment-list-item-text body">'+t.comment_text+"</div>"),e.append('<p class="comment-list-item-text meta"> '+o+" | "+r+" | "+a+"</p>"),n.append(e)}),a=n[0].outerHTML,o(a)}var o={};return o.getForRdStory=function(e,o){var n="http://www.reddit.com/comments/"+e+".json";$.get(n,function(e){t(e,o)})},o.getForHnStory=function(t,o){var n="https://hn.algolia.com/api/v1/search?tags=comment,story_"+t.sourceId;$.get(n,function(n){e(t,n,o)})},o}();var NB=NB||{};NB.StoryPanel=function(){function t(t,e){var o="/readability/",n=t.url,r=o+encodeURIComponent(n);$.get(r,function(o){if(o.error){var n=["<h2>Whoa!</h2>","<p>This is far too good for this little panel. Better go see the whole thing ",'<a href="'+t.url+'" target="_blank">here</a>.',"</p>"].join("");e(n)}else e(o.content)})}function e(e){function o(){NB.StoryModel.setCurrentStory("panel",e)}var n=e.rd.domain.toLowerCase();if(e.rd.self)NB.Comments.getForRdStory(e.rd.shortId,function(t){e.content=t.html(),o()});else if(e.url.match(/\.(gif|png|jpg)\?*.*$/))e.content='<img src="'+e.url+'">',o();else if("i.imgur.com"===n||"imgur.com"===n||"m.imgur.com"===n)if(e.url.match(/\imgur\.com\/a\//)){var r=e.url.replace(/.*?\imgur\.com\/a\//,"");r=r.replace(/#.*/,""),r=r.replace(/\?.*/,"");var a="https://api.imgur.com/3/album/"+r+"/images",i="";$.get(a,function(t){i+='<div class="story-content">',t.data.forEach(function(t){i+='<img src="'+t.link+'"><br>'}),i+="</div>",e.content=i,o()})}else{var s=e.url.replace("imgur.com","i.imgur.com")+".jpg";e.content=['<div class="story-content">','<a href="'+e.url+'" target="_blank"><img src="'+s+'"></a>',"<br>",'<a href="'+e.url+'" target="_blank">Go to imgur.</a>.',"</div>"].join(""),o()}else t(e,function(t){e.content=t,o()})}function o(e){e.url?e.url.match(/pdf\?*.*$/)?(e.content='<a href="'+e.url+'" target="_blank">Download/open this PDF</a>',NB.StoryModel.setCurrentStory("panel",e)):t(e,function(t){e.content=t,NB.StoryModel.setCurrentStory("panel",e)}):NB.Comments.getForHnStory(e,function(t){e.content=t,NB.StoryModel.setCurrentStory("panel",e)})}var n={};return n.render=function(t){"rd"===t.source&&e(t),"hn"===t.source&&o(t)},n}();var NB=NB||{};NB.StoryModel=function(){var t={};return t.tooltipStory={name:ko.observable(),url:ko.observable(),sourceUrl:ko.observable(),authorUrl:ko.observable(),domain:ko.observable(),category:ko.observable(),color:ko.observable(),author:ko.observable(),commentCount:ko.observable(),score:ko.observable(),timeString:ko.observable(),dateString:ko.observable()},t.panelStory={name:ko.observable("News Bubbles"),url:ko.observable(),sourceUrl:ko.observable(),authorUrl:ko.observable(),domain:ko.observable(),category:ko.observable(),color:ko.observable(),author:ko.observable(),commentCount:ko.observable(),score:ko.observable(),timeString:ko.observable(),dateString:ko.observable(),content:ko.observable("Select a bubble on the left do display its content here.")},t.setCurrentStory=function(e,o){var n,r,a,i=t[e+"Story"],s=d3.time.format("%a, %-e %b %Y"),c=d3.time.format("%-I:%M%p"),l=o.url,u=o.name,d=o.category||"",g=NB.Settings.getColor(o.source,d);if("rd"===o.source&&(n=o.rd.domain,r="https://www.reddit.com"+o.rd.permalink,a="http://www.reddit.com/user/"+o.author),"hn"===o.source)if(r="https://news.ycombinator.com/item?id="+o.sourceId,a="https://news.ycombinator.com/user?id="+o.author,o.url||(l=r),o.name.toLowerCase().indexOf("show hn")>-1)n="Show HN",u=u.replace("Show HN: ","");else if(o.name.toLowerCase().indexOf("ask hn")>-1)n="Ask HN",l=r,u=u.replace("Ask HN: ","");else{var m=o.url.match(/:\/\/([^\/]*)/);n=m?m[1]?m[1]:"HN":"Hacker News"}"tooltip"===e&&u.length>50&&(u=u.substr(0,47).trim()+"..."),i.name(u).url(l).sourceUrl(r).authorUrl(a).domain(n).category(d).color(g).author(o.author).commentCount(o.commentCount).score(Math.round(o.score)).timeString(c(o.postDate)).dateString(s(o.postDate)),"panel"===e&&i.content(o.content)},t}();var NB=NB||{};NB.main=function(){NB.splitPos=document.body.offsetWidth-NB.RESIZER_WIDTH,NB.Layout.render(),NB.Layout.init();var t=NB.Settings.getSetting("source")||"rd",e=NB.Settings.getSetting(t+"MinScore"),o=$("#news-source-rd"),n=$("#news-source-hn");"rd"===t?(o.addClass("active"),n.removeClass("active")):"hn"===t&&(o.removeClass("active"),n.addClass("active")),NB.Data.getData(t,e),ko.applyBindings(NB.StoryModel.tooltipStory,document.getElementById("story-tooltip")),ko.applyBindings(NB.StoryModel.panelStory,document.getElementById("story-panel")),"ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch||(d3.select("body").classed("no-touch",!0),NB.hasTouch=!1)}();