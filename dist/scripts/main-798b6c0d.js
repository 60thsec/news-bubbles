"use strict";var NB=NB||{};NB.DUR=200,NB.RESIZER_WIDTH=24,NB.splitPos=0,NB.MIN_POINTS=1,NB.HITS_PER_PAGE=200,NB.POLL_PERIOD=3e5,NB.hasTouch=!0;var NB=NB||{};NB.Data=function(){function t(t,e){e=e||"commentCount",t.sort(function(t,o){return o[e]-t[e]})}function e(e){return e.forEach(function(t){var e=new Date(t.created_at);t.postDate=e;var o=t.num_comments;t.commentCount=o,t.name=t.title,t.score=t.points,t.id="hn-"+t.objectID,t.sourceId=t.objectID,t.source="hn"}),t(e,"commentCount"),e}function o(e){return e.forEach(function(t){var e=new Date(t.postDate);t.postDate=e}),t(e,"commentCount"),e}function n(e){return e.forEach(function(t){var e=new Date(t.data.created);t.postDate=e;var o=t.data.num_comments;t.commentCount=o,t.score=t.data.score,t.id="rd-"+t.data.name,t.sourceId=t.data.name,t.source="rd",t.name=t.data.title,t.url=t.data.url,t.author=t.data.author,t.thumb=t.data.thumbnail}),t(e,"commentCount"),console.log("parsed reddit data:",e),e}function a(t){t.forEach(function(t){var e=l.stories.filter(function(e){return e.id===t.id})[0];e?(e.commentCount=t.commentCount,e.score=t.score):l.stories.push(t)})}function r(t){var o="search_by_date?";o+="tags=(story,show_hn,ask_hn)",o+="&hitsPerPage="+NB.HITS_PER_PAGE,o+="&numericFilters=points>="+NB.MIN_POINTS,$.get("https://hn.algolia.com/api/v1/"+o,function(o){console.log("Updated data at",Date()),o=o.hits,l.stories=e(o),t()})}function s(t){var e="http://www.reddit.com/hot.json?limit=100";$.get(e,function(e){console.log("got data from reddit:",e),e=e.data.children,l.stories=n(e),t()})}function i(){c=io(),c.on("data",function(t){if(console.log("Got data from:",t.source),console.log(t.data),t.data.length&&t.source===NB.source){var e=o(t.data);a(e),NB.Chart.drawStories()}})}var c,l={},u={},d=[];return localStorage.readList&&(d=JSON.parse(localStorage.readList)),l.stories=[],l.setData=function(t,e){u[t]=e},l.markAsRead=function(t){d.push(t),localStorage.readList=JSON.stringify(d)},l.isRead=function(t){for(var e=t.toString(),o=0;o<d.length;o++)if(e===d[o])return!0;return!1},l.getRedditData=function(t){s(t,!1)},l.getHNStories=function(t){r(t,!1)},l.goBananas=function(){console.log("Get comfortable..."),$.get("/api/getall",function(t){a(o(t)),console.log("Got",t.length,"stories"),NB.Chart.drawStories()})},i(),l}();var NB=NB||{};NB.Layout=function(){function t(){r.style("width",NB.splitPos+"px"),s.style("left",NB.splitPos+"px")}function e(){t(),r.style("display","block"),s.style("display","block")}function o(){i||(i=!0,d3.select("#story-panel-toggle").text("»"),NB.splitPos=.618*document.body.offsetWidth,t(),NB.Chart.resize(!0))}function n(e){(e||i)&&(i=!1,d3.select("#story-panel-toggle").text("«"),NB.splitPos=document.body.offsetWidth-NB.RESIZER_WIDTH,t(),NB.Chart.resize())}var a={},r=d3.select("#chart-wrapper"),s=d3.select("#story-panel"),i=!1;return a.render=function(){t(),document.body.offsetWidth-NB.splitPos<100&&n(!0),i||NB.splitPos+NB.RESIZER_WIDTH===document.body.offsetWidth||n(!0)},a.moveSplitPos=function(){i||(i=!0,d3.select("#story-panel-toggle").text("»")),t()},a.showStoryPanel=function(){o()},a.hideStoryPanel=function(){n()},a.toggleStoryPanel=function(){i?n():o()},a.init=function(){e()},a}();var NB=NB||{};NB.Chart=function(){function t(t){var e=d3.select(d3.event.currentTarget);d3.select(".selected").classed("read",!0).classed("selected",!1),e.classed("selected",!0),NB.Data.markAsRead(t.id),NB.Layout.showStoryPanel(),$("#story-content").html(""),x.style("visibility","hidden");var o="";if(t.url){if(o+='<h1><a class="title" href="'+t.url+'" target="_blank">'+t.name+"</a></h1>",t.data&&t.data.is_self){$("#story-title").html(o);var n=[t.data.selftext+"<hr>","<p>Built-in reddit comments coming soon. For now, head over to ",'<a href="'+t.url+'" target="_blank">reddit to read more</a>.',"</p>"].join("");return void $("#story-content").html(n)}if(t.url.match(/\.(gif|png|jpg)\?*.*$/))return $("#story-title").html(o),void $("#story-content").html('<a href="'+t.url+'" target="_blank"><img src="'+t.url+'"></a>');if(t.data&&"imgur.com"===t.data.domain){var a=t.url.replace("imgur.com","i.imgur.com")+".jpg";$("#story-title").html(o);var n=["<p>Embedded imgur magic coming soon.",'<a href="'+t.url+'" target="_blank"><img src="'+a+'"></a>',"<br>",'<a href="'+t.url+'" target="_blank">Go to imgur.</a>.',"</p>"].join("");return void $("#story-content").html(n)}}else o+="<h1>"+t.name+"</h1>";if(o+='<p class="sub-title">'+Math.round(t.score)+" points | ","hn"===NB.source&&(o+='<a href="https://news.ycombinator.com/item?id='+t.sourceId+'" target="_blank">'+t.commentCount+" comments</a> | "),o+="posted by "+t.author+"</p>",t.url){var r="/readability/",s=t.url,i=r+encodeURIComponent(s);$.get(i,function(e){if(e.error){var o=["<h2>Oh no.</h2>","<p>This article could not be fetched. You can visit the full page ",'<a href="'+t.url+'" target="_blank">here</a>.',"</p>"].join("");$("#story-content").html(o)}$("#story-content").html(e.content)})}else $("#story-content").html(t.story_text);$("#story-title").html(o)}function e(t){x.text(t.name);var e=parseInt(x.style("width")),o=parseInt(x.style("height")),n=this.getBoundingClientRect(),a=n.left-(e-n.width)/2;a=Math.max(a,P.left),a=Math.min(a,N-P.right-e);var r=n.top-o;100>r&&(r=n.top+n.height),x.style("left",a+"px").style("top",r+"px").style("visibility","visible")}function o(){x.style("visibility","hidden")}function n(n){var a=u.selectAll("circle").data(NB.Data.stories,function(t){return t.id});a.classed("updating",!0),a.enter().append("circle").attr("r",function(t){return g(t.commentCount)}).attr("cx",function(){return f(I)}).attr("cy",function(){return p(0)}).classed("story-circle",!0).classed("read",function(t){return NB.Data.isRead(t.id)}).on("click",t).on("mouseover",e).on("mouseout",o);var r=0;n&&(r=NB.DUR),a.transition().duration(r).attr("r",function(t){return g(t.commentCount)}).attr("cx",function(t){return f(t.postDate)}).attr("cy",function(t){return p(t.score)})}function a(){y=parseInt(d3.select("#chart-wrapper").style("height"),10)-4,N=NB.splitPos,B.ticks(N-P.left-P.right<600?5:10),h=document.body.offsetHeight/20,P.top=40+h/2,l.attr("width",N).attr("height",y),m.attr("transform","translate("+P.left+","+P.top+")").attr("width",N-P.left-P.right).attr("height",y-P.top-P.bottom),d.attr("x",P.left).attr("y",0).attr("width",N-P.left).attr("height",y-P.bottom),f.range([40,N-20]),p.range([y-P.bottom-7,P.top]),g.range([7,h]),w.x(f),b.attr("transform","translate(0,"+(y-P.bottom)+")"),v.innerTickSize(-1*(N-P.left-P.right)),D.attr("transform","translate("+P.left+", 0)"),b.call(B),D.call(v),D.selectAll("text").attr("x",4).attr("dy",-4).style("text-anchor","start")}function r(){_=Math.min(_,d3.min(NB.Data.stories,function(t){return t.postDate})),I=Math.max(I,d3.max(NB.Data.stories,function(t){return t.postDate})),C=Math.max(C,d3.max(NB.Data.stories,function(t){return t.score})),k=Math.min(k,d3.min(NB.Data.stories,function(t){return t.commentCount})),R=Math.max(R,d3.max(NB.Data.stories,function(t){return t.commentCount})),f.domain([_,I]),p.domain([NB.MIN_POINTS,C]),g.domain([k,R]),w.x(f)}function s(){b.call(B),n()}function i(){w=d3.behavior.zoom().x(f).scaleExtent([1,1/0]).on("zoom",s)}function c(){l=d3.select("#svg-bubble-chart"),x=d3.select("#tooltip"),f=d3.time.scale(),p=d3.scale.pow().exponent(.5),g=d3.scale.pow().exponent(.5),B=d3.svg.axis().scale(f).ticks(8).tickSize(3,0),v=d3.svg.axis().scale(p).orient("left").ticks(15).tickSize(0,0);var t=l.append("g").classed("chart-axis",!0);b=t.append("g").classed("chart-axis-x",!0),D=t.append("g").classed("chart-axis-y",!0),i(),u=l.append("g").classed("chart-plot-area",!0).style("pointer-events","all").call(w),m=u.append("rect").attr("class","overlay"),m.on("touchstart.zoom",null),d=d3.select("#plot-area-clip rect")}var l,u,d,m,h,f,p,g,N,y,B,v,b,D,x,w,S={},P={top:70,right:0,bottom:30,left:0},_=1/0,I=0,C=0,k=1/0,R=0;return S.drawStories=function(){r(),a(),n(!0)},S.resize=function(t){NB.Data.stories.length&&(a(),r(),n(t))},c(),S}();var NB=NB||{};NB.Events=function(){function t(t){return"story-panel-toggle"===d3.event.target.id?!1:(console.log("#story-panel-resizer clicked:",t),a=d3.select("#chart-wrapper").style("transition","0ms"),n=d3.select("#story-panel").style("transition","0ms"),r=d3.select("#story-panel-resizer").classed("active",!0),i=d3.select("body"),s=d3.mouse(document.body)[0]-NB.splitPos,i.on("mousemove",e),i.on("mouseup",o),i.on("touchmove",e),void i.on("touchend",o))}function e(){d3.event.preventDefault(),NB.splitPos=Math.max(100,d3.mouse(document.body)[0]-s),NB.Layout.moveSplitPos(),NB.Chart.resize()}function o(){a.style("transition",null),n.style("transition",null),r.classed("active",!1),document.body.offsetWidth-NB.splitPos<100&&NB.Layout.hideStoryPanel(),i.on("mousemove",null),i.on("mouseup",null),i.on("touchmove",null),i.on("touchend",null)}var n,a,r,s,i,c={};return d3.select("#story-panel-resizer").on("mousedown",t),d3.select("#story-panel-resizer").on("touchstart",t),d3.select("#story-panel-toggle").on("click",function(){return console.log("#story-panel-toggle clicked"),d3.event.preventDefault(),NB.Layout.toggleStoryPanel(),!1}),$("#more-btn").on("click",function(){NB.Data.getNextPage(function(t){NB.Chart.addStories(t)})}),window.onresize=function(){NB.Layout.render(),NB.Chart.resize()},c}();var NB=NB||{};NB.main=function(){NB.splitPos=document.body.offsetWidth-NB.RESIZER_WIDTH,NB.Layout.render(),NB.Layout.init(),NB.source="rd";var t=document.location.search.replace("?src=","");"rd"===t?NB.source="rd":"hn"===t&&(NB.source="hn"),"rd"===NB.source?NB.Data.getRedditData(function(t){NB.Chart.drawStories(t)}):NB.Data.getHNStories(function(){NB.Chart.drawStories()}),"ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch||(d3.select("body").classed("no-touch",!0),NB.hasTouch=!1)}();